<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEBULA ARIYA</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
            cursor: none;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #fff;
            backdrop-filter: blur(5px);
        }
        
        h1 {
            font-size: 4em;
            color: #fff;
            text-shadow: 2px 2px 0 #f00;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 0.8em;
            color: #ccc;
            margin-top: 10px;
        }
        
        .file-upload-section {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #fff;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(5px);
        }
        
        .section-title {
            font-size: 1em;
            margin-bottom: 15px;
            color: #fff;
            text-shadow: 1px 1px 0 #f00;
        }
        
        .upload-area {
            border: 2px dashed #fff;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .upload-area:hover {
            border-color: #f00;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .upload-area.dragover {
            border-color: #f00;
            background: rgba(255, 0, 0, 0.2);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 12px 25px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.8em;
            transition: all 0.3s ease;
            margin: 10px 5px;
            text-transform: uppercase;
        }
        
        .btn:hover {
            background: #f00;
            border-color: #f00;
            box-shadow: 2px 2px 0 #fff;
        }
        
        .btn:active {
            box-shadow: none;
            transform: translate(2px, 2px);
        }
        
        .btn.success {
            background: #fff;
            color: #000;
            border-color: #fff;
        }
        
        .btn.paused {
            background: #f00;
            border-color: #f00;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #fff;
            padding: 25px;
            backdrop-filter: blur(5px);
            min-height: 400px;
        }
        
        .card-title {
            font-size: 1em;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 1px 1px 0 #f00;
            border-bottom: 2px solid #fff;
            padding-bottom: 10px;
        }
        
        .cards-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .cards-row {
                grid-template-columns: 1fr;
            }
        }
        
        .plot-container {
            height: 350px;
            width: 100%;
        }
        
        .circuit-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 15px;
        }
        
        .molecular-viewer {
            height: 350px;
            width: 100%;
            border: 2px solid #fff;
            background: rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
        }
        
        .molecular-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            font-size: 0.6em;
            color: #ccc;
            background: rgba(0, 0, 0, 0.8);
            padding: 8px;
            border: 1px solid #666;
            z-index: 10;
        }
        
        #nh3-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #fff;
        }
        
        .summary-table th,
        .summary-table td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid #fff;
            font-size: 0.7em;
        }
        
        .summary-table th {
            background: rgba(255, 0, 0, 0.2);
            color: #fff;
            text-shadow: 1px 1px 0 #000;
        }
        
        .summary-table tr:hover {
            background: rgba(255, 0, 0, 0.1);
        }
        
        .variant-selector select {
            background: #000;
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 15px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.7em;
            width: 100%;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            padding: 12px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .stat-box.highlight-box {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #f00;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .stat-value {
            font-size: 1.1em;
            color: #f00;
            display: block;
            text-shadow: 1px 1px 0 #000;
            word-break: break-word;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .highlight-box .stat-value {
            color: #fff;
            text-shadow: 2px 2px 0 #f00;
        }
        
        .stat-label {
            font-size: 0.55em;
            color: #ccc;
            margin-top: 5px;
            line-height: 1.3;
            word-break: break-word;
            hyphens: auto;
        }
        
        .highlight-stat {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #220000, #110000);
            border: 2px solid #f00;
            border-radius: 5px;
        }
        
        .stat-big-value {
            font-size: 2.5em;
            color: #fff;
            text-shadow: 2px 2px 0 #f00;
            display: block;
            margin-bottom: 10px;
        }
        
        .highlight-stat .stat-label {
            font-size: 0.8em;
            color: #ccc;
        }
        
        .hamiltonian-container {
            height: 350px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
            border-radius: 5px;
        }
        
        .hamiltonian-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .hamiltonian-term {
            background: linear-gradient(135deg, rgba(255, 0, 0, 0.1), rgba(0, 0, 0, 0.8));
            border: 1px solid #f00;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            position: relative;
            overflow: hidden;
        }
        
        .hamiltonian-term::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .term-coefficient {
            color: #fff;
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: 1px 1px 0 #f00;
        }
        
        .term-operator {
            color: #ff8800;
            font-size: 0.8em;
            margin: 0 5px;
        }
        
        .term-pauli {
            color: #00ffff;
            font-size: 0.8em;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0 #000;
        }
        
        .hamiltonian-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 0, 0, 0.05);
            border: 1px solid #f00;
            border-radius: 5px;
        }
        
        .hamiltonian-stat {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 3px;
        }
        
        .hamiltonian-stat .stat-value {
            color: #f00;
            font-size: 1em;
            font-weight: bold;
            display: block;
            text-shadow: 1px 1px 0 #000;
        }
        
        .hamiltonian-stat .stat-label {
            color: #ccc;
            font-size: 0.6em;
            margin-top: 5px;
        }
        
        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #f00;
            padding: 15px;
            margin: 20px 0;
            color: #fff;
        }
        
        .success-message {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            padding: 15px;
            margin: 20px 0;
            color: #fff;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1em;
            color: #ccc;
        }
        
        .animation-controls {
            display: none;
        }
        
        .speed-control {
            display: none;
        }
        
        .progress-bar {
            display: none;
        }
        
        /* Intro Animation Canvas - Initially Hidden */
        #intro-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: #000;
            transition: opacity 1s ease-out;
            display: none;
        }
        
        #intro-canvas.show {
            display: block;
        }
        
        #intro-canvas.fade-out {
            opacity: 0;
        }
        
        /* Upload Section Initially Visible */
        .upload-section {
            opacity: 1;
            transition: opacity 1s ease-out;
        }
        
        .upload-section.fade-out {
            opacity: 0;
        }
        
        /* Dashboard Content Initially Hidden */
        .dashboard-content {
            opacity: 0;
            transition: opacity 1.5s ease-in;
            display: none;
        }
        
        .dashboard-content.show {
            opacity: 1;
            display: block;
        }
        
        /* Show Results Button */
        #show-results-btn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            opacity: 0;
            transition: opacity 1s ease-in;
            background: #000;
            color: #fff;
            border: 3px solid #fff;
            padding: 20px 40px;
            font-family: 'Press Start 2P', monospace;
            font-size: 1.2em;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: none;
        }
        
        #show-results-btn:hover {
            background: #f00;
            border-color: #f00;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        #show-results-btn.show {
            opacity: 1;
            display: block;
        }

        /* Interactive Background */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
        }
        
        /* Custom Cursor */
        #custom-cursor {
            position: fixed;
            left: 0;
            top: 0;
            width: 24px;
            height: 32px;
            pointer-events: none;
            z-index: 100;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }
        
        #custom-cursor.active {
            transform: translate(-50%, -50%) scale(1.2);
        }
        
        /* Explosion particles */
        .explosion-particle {
            position: fixed;
            width: 4px;
            height: 4px;
            pointer-events: none;
            z-index: 99;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 3em;
            }
            
            .btn {
                font-size: 0.7em;
                padding: 8px 15px;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000;
            border: 1px solid #fff;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #f00;
            border: 1px solid #fff;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }
    </style>
</head>
<body>
    <canvas id="intro-canvas"></canvas>
    <button id="show-results-btn">Show Results</button>
    <canvas id="bg-canvas"></canvas>
    <div id="custom-cursor"></div>
    
    <div class="container">
        <div class="upload-section">
            <div class="header">
                <h1>NEBULA</h1>
                <p class="subtitle">Enhanced VQE : UCCSD Ansatz ,Hybrid Optimization and ZNE Denoiser</p>
            </div>
            
            <div class="file-upload-section">
                <h3 class="section-title">LOAD VQE DATA</h3>
                <div class="upload-area" id="uploadArea">
                    <p>Upload your VQE JSON file</p>
                            <button class="btn" id="uploadBtn">
                                UPLOAD FILE
                            </button>
                    <button class="btn" id="startBtn" onclick="processUploadedData()" style="margin-left: 20px; background-color: #00cc66; display: none;">
                        START ANALYSIS
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".json" />
                </div>
                <div id="fileStatus"></div>
            </div>
            
            <div id="loadingMessage" class="loading" style="display: none;">
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="dashboard-grid">
                <!-- Summary Statistics -->
                <div class="card full-width">
                    <h3 class="card-title">SUMMARY STATISTICS</h3>
                    <div class="stats-grid" id="statsGrid">
                        <!-- Stats will be populated here -->
                    </div>
                    <table class="summary-table" id="summaryTable">
                        <thead>
                            <tr>
                                <th>Variant</th>
                                <th>Final Energy (Ha)</th>
                                <th>Best Energy (Ha)</th>
                                <th>Improvement (Ha)</th>
                                <th>Iterations</th>
                                <th>Parameters</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <!-- Energy Convergence Plot -->
                <div class="card full-width">
                    <h3 class="card-title">ENERGY CONVERGENCE - ALL VARIANTS</h3>
                    <div class="plot-container" style="height: 500px;" id="convergencePlotAll"></div>
                </div>
                
                <!-- Energy Comparison Chart -->
                <div class="card full-width">
                    <h3 class="card-title">ENERGY COMPARISON ACROSS VARIANTS</h3>
                    <div class="plot-container comparison-chart" id="comparisonChart"></div>
                </div>
                
                <!-- Individual Variant Analysis -->
                <div class="card">
                    <h3 class="card-title">INDIVIDUAL VARIANT ANALYSIS</h3>
                    <div class="variant-selector">
                        <select id="variantSelect">
                            <option value="">Select a variant...</option>
                        </select>
                    </div>
                    <div class="plot-container energy-convergence" id="convergencePlot"></div>
                </div>
                
                <!-- Parameter Analysis -->
                <div class="card">
                    <h3 class="card-title">PARAMETER ANALYSIS</h3>
                    <div class="plot-container" id="parameterPlot"></div>
                </div>
            </div>
        </div>
        
        </div>
        
        <div id="loadingMessage" class="loading" style="display: none;">
            LOAD A VQE RESULTS JSON FILE TO BEGIN ANALYSIS...
        </div>
    </div>

    <script>
        // ======= INTRO ANIMATION =======
        const introCanvas = document.getElementById('intro-canvas');
        const introCtx = introCanvas.getContext('2d');
        const uploadSection = document.querySelector('.upload-section');
        const dashboardContent = document.querySelector('.dashboard-content');
        const showResultsBtn = document.getElementById('show-results-btn');
        
        let introWidth = window.innerWidth;
        let introHeight = window.innerHeight;
        introCanvas.width = introWidth;
        introCanvas.height = introHeight;
        
        let introStars = [];
        let animationTime = 0;
        const ANIMATION_DURATION = 6000; // 6 seconds
        const NUM_INTRO_STARS = 200;
        let introAnimationId;
        let animationStarted = false;
        
        // Spaceship sprite data (pixel art) - BIGGER AND COOLER
        const spaceship = {
            x: introWidth / 2 - 25, // Increased from 15 to 25
            y: introHeight - 80,    // Increased from 60 to 80
            width: 50,              // Increased from 30 to 50
            height: 70              // Increased from 40 to 70
        };
        
        // Initialize intro stars
        function createIntroStars() {
            introStars = [];
            for (let i = 0; i < NUM_INTRO_STARS; i++) {
                introStars.push({
                    x: Math.random() * introWidth,
                    y: Math.random() * introHeight,
                    speed: Math.random() * 8 + 2,
                    size: Math.random() * 4 + 1,
                    color: ['#fff', '#f00', '#888'][Math.floor(Math.random() * 3)],
                    trail: []
                });
            }
        }
        
        // Draw pixel-perfect rectangle
        function drawPixelRect(x, y, width, height, color) {
            introCtx.fillStyle = color;
            introCtx.fillRect(Math.round(x), Math.round(y), Math.round(width), Math.round(height));
        }
        
        // Draw spaceship sprite - ULTRA ENHANCED STARFIGHTER
        function drawSpaceship() {
            const { x, y, width, height } = spaceship;
            
            // Enhanced animation variables for maximum coolness
            const thrusterFlicker = Math.sin(animationTime * 0.08) * 0.5 + 0.5;
            const pulseEffect = Math.sin(animationTime * 0.05) * 0.4 + 0.6;
            const engineGlow = Math.sin(animationTime * 0.1) * 0.5 + 0.5;
            const warpField = Math.sin(animationTime * 0.03) * 0.3 + 0.7;
            const shieldPulse = Math.sin(animationTime * 0.06) * 0.3 + 0.7;
            const weaponCharge = Math.sin(animationTime * 0.12) * 0.4 + 0.6;
            
            // QUANTUM NOSE ARRAY - Advanced targeting system
            drawPixelRect(x + 23, y, 4, 6, '#ffffff'); // Main nose cone
            drawPixelRect(x + 22, y + 6, 6, 3, '#e0e0e0'); // Nose body
            drawPixelRect(x + 21, y + 9, 8, 3, '#00ffff'); // Quantum sensor array
            
            // Targeting laser (flashing)
            if (Math.sin(animationTime * 0.15) > 0.3) {
                drawPixelRect(x + 24, y + 1, 2, 1, '#ff0000');
            }
            
            // ENHANCED COCKPIT SECTION - Battle command center
            drawPixelRect(x + 20, y + 12, 10, 4, '#ffffff'); // Upper cockpit
            drawPixelRect(x + 19, y + 16, 12, 3, '#dddddd'); // Cockpit body
            
            // Advanced cockpit displays with multiple colors
            const cockpitColor1 = `hsl(200, 100%, ${70 + pulseEffect * 30}%)`;
            const cockpitColor2 = `hsl(240, 100%, ${60 + pulseEffect * 25}%)`;
            const cockpitColor3 = `hsl(300, 100%, ${65 + pulseEffect * 20}%)`;
            drawPixelRect(x + 20, y + 13, 3, 4, cockpitColor1); // Left display
            drawPixelRect(x + 27, y + 13, 3, 4, cockpitColor2); // Right display
            drawPixelRect(x + 23, y + 14, 4, 2, cockpitColor3); // Center HUD
            
            // Pilot viewport (darker tint)
            drawPixelRect(x + 22, y + 15, 6, 2, '#334466');
            
            // MAIN BATTLESHIP HULL - Armored sections
            drawPixelRect(x + 18, y + 19, 14, 4, '#cccccc'); // Upper hull armor
            drawPixelRect(x + 17, y + 23, 16, 4, '#bbbbbb'); // Mid hull section
            drawPixelRect(x + 16, y + 27, 18, 4, '#aaaaaa'); // Lower hull section
            
            // Hull reinforcement lines
            drawPixelRect(x + 18, y + 20, 14, 1, '#ffffff');
            drawPixelRect(x + 17, y + 24, 16, 1, '#ffffff');
            drawPixelRect(x + 16, y + 28, 18, 1, '#ffffff');
            
            // ADVANCED WEAPON SYSTEMS - Multiple weapon types
            const weaponGlow = weaponCharge > 0.8 ? '#ffffff' : 
                              weaponCharge > 0.6 ? '#ffff00' : 
                              weaponCharge > 0.4 ? '#ff8800' : '#ff0000';
            
            // Plasma cannons (left and right) - Main weapons
            drawPixelRect(x + 12, y + 24, 4, 3, weaponGlow);
            drawPixelRect(x + 34, y + 24, 4, 3, weaponGlow);
            
            // Quantum torpedo tubes
            drawPixelRect(x + 14, y + 20, 2, 2, weaponGlow);
            drawPixelRect(x + 34, y + 20, 2, 2, weaponGlow);
            
            // Pulse laser arrays
            if (weaponCharge > 0.7) {
                drawPixelRect(x + 13, y + 22, 1, 1, '#00ffff');
                drawPixelRect(x + 35, y + 22, 1, 1, '#00ffff');
                drawPixelRect(x + 24, y + 18, 2, 1, '#00ffff'); // Forward array
            }
            
            // MEGA WING ASSEMBLIES - Advanced aerodynamics
            // Left wing complex with detailed structure
            drawPixelRect(x + 8, y + 22, 10, 3, '#888888'); // Main wing
            drawPixelRect(x + 6, y + 25, 12, 3, '#777777'); // Wing extension
            drawPixelRect(x + 4, y + 28, 14, 3, '#666666'); // Wing base
            drawPixelRect(x + 2, y + 31, 16, 2, '#555555'); // Wing tip section
            drawPixelRect(x + 0, y + 33, 18, 2, '#444444'); // Outer wing
            
            // Right wing complex
            drawPixelRect(x + 32, y + 22, 10, 3, '#888888'); // Main wing
            drawPixelRect(x + 32, y + 25, 12, 3, '#777777'); // Wing extension
            drawPixelRect(x + 32, y + 28, 14, 3, '#666666'); // Wing base
            drawPixelRect(x + 32, y + 31, 16, 2, '#555555'); // Wing tip section
            drawPixelRect(x + 32, y + 33, 18, 2, '#444444'); // Outer wing
            
            // Wing weapon hardpoints
            drawPixelRect(x + 10, y + 26, 2, 2, weaponGlow);
            drawPixelRect(x + 38, y + 26, 2, 2, weaponGlow);
            
            // Navigation lights (blinking)
            const navLightColor = Math.sin(animationTime * 0.12) > 0 ? '#00ff00' : '#004400';
            const strobeLightColor = Math.sin(animationTime * 0.2) > 0.5 ? '#ff0000' : '#440000';
            drawPixelRect(x + 2, y + 25, 2, 2, navLightColor);
            drawPixelRect(x + 46, y + 25, 2, 2, navLightColor);
            drawPixelRect(x + 0, y + 34, 2, 1, strobeLightColor);
            drawPixelRect(x + 48, y + 34, 2, 1, strobeLightColor);
            
            // SHIELD MATRIX GENERATORS - Defensive systems
            const shieldColor = `hsl(180, 100%, ${40 + shieldPulse * 40}%)`;
            const shieldActive = shieldPulse > 0.6;
            
            if (shieldActive) {
                // Shield emitters
                drawPixelRect(x + 15, y + 18, 2, 2, shieldColor);
                drawPixelRect(x + 33, y + 18, 2, 2, shieldColor);
                drawPixelRect(x + 24, y + 16, 2, 2, shieldColor); // Nose shield
                
                // Shield field outline (when active)
                if (shieldPulse > 0.8) {
                    // Draw shield bubble outline
                    drawPixelRect(x + 10, y + 10, 30, 1, shieldColor);
                    drawPixelRect(x + 8, y + 12, 34, 1, shieldColor);
                    drawPixelRect(x + 7, y + 35, 36, 1, shieldColor);
                    drawPixelRect(x + 10, y + 37, 30, 1, shieldColor);
                }
            }
            
            // MAIN ENGINE COMPLEX - Quantum fusion drive
            drawPixelRect(x + 15, y + 31, 20, 5, '#999999'); // Engine housing
            drawPixelRect(x + 16, y + 36, 18, 4, '#888888'); // Engine core housing
            drawPixelRect(x + 17, y + 40, 16, 3, '#777777'); // Exhaust manifold
            
            // Engine detail lines
            drawPixelRect(x + 18, y + 32, 14, 1, '#bbbbbb');
            drawPixelRect(x + 19, y + 38, 12, 1, '#aaaaaa');
            
            // QUANTUM FUSION DRIVE SYSTEM - 5 engine configuration
            const thrusterColors = [
                thrusterFlicker > 0.9 ? '#ffffff' : '#ffff88',
                thrusterFlicker > 0.7 ? '#ffff00' : '#ffaa00',
                thrusterFlicker > 0.5 ? '#ff8800' : '#ff4400',
                thrusterFlicker > 0.3 ? '#ff4400' : '#ff0000',
                thrusterFlicker > 0.1 ? '#ff0000' : '#cc0000'
            ];
            
            // Left engine cluster - Advanced thrust vectoring
            drawPixelRect(x + 12, y + 43, 4, 6, thrusterColors[0]);
            drawPixelRect(x + 10, y + 49, 8, 4, thrusterColors[1]);
            drawPixelRect(x + 8, y + 53, 12, 4, thrusterColors[2]);
            if (thrusterFlicker > 0.5) {
                drawPixelRect(x + 6, y + 57, 16, 5, thrusterColors[3]);
                drawPixelRect(x + 4, y + 62, 20, 4, thrusterColors[4]);
                // Plasma shockwave
                if (thrusterFlicker > 0.8) {
                    drawPixelRect(x + 2, y + 66, 24, 3, thrusterColors[4]);
                }
            }
            
            // Center main engine - Most powerful quantum fusion core
            drawPixelRect(x + 20, y + 43, 10, 8, thrusterColors[0]);
            drawPixelRect(x + 18, y + 51, 14, 6, thrusterColors[1]);
            drawPixelRect(x + 16, y + 57, 18, 5, thrusterColors[2]);
            if (thrusterFlicker > 0.3) {
                drawPixelRect(x + 14, y + 62, 22, 6, thrusterColors[3]);
                drawPixelRect(x + 12, y + 68, 26, 5, thrusterColors[4]);
                // Main plasma jet
                if (thrusterFlicker > 0.7) {
                    drawPixelRect(x + 10, y + 73, 30, 4, thrusterColors[4]);
                    drawPixelRect(x + 15, y + 77, 20, 3, thrusterColors[3]);
                }
            }
            
            // Right engine cluster
            drawPixelRect(x + 34, y + 43, 4, 6, thrusterColors[0]);
            drawPixelRect(x + 32, y + 49, 8, 4, thrusterColors[1]);
            drawPixelRect(x + 30, y + 53, 12, 4, thrusterColors[2]);
            if (thrusterFlicker > 0.5) {
                drawPixelRect(x + 28, y + 57, 16, 5, thrusterColors[3]);
                drawPixelRect(x + 26, y + 62, 20, 4, thrusterColors[4]);
                // Plasma shockwave
                if (thrusterFlicker > 0.8) {
                    drawPixelRect(x + 24, y + 66, 24, 3, thrusterColors[4]);
                }
            }
            
            // WARP NACELLES - Faster-than-light capability
            const warpColor = `hsl(240, 100%, ${50 + warpField * 40}%)`;
            const warpGlow = `hsl(280, 100%, ${60 + warpField * 30}%)`;
            
            drawPixelRect(x + 6, y + 32, 6, 8, warpColor);
            drawPixelRect(x + 38, y + 32, 6, 8, warpColor);
            
            // Warp field generators
            if (warpField > 0.7) {
                drawPixelRect(x + 7, y + 33, 4, 6, warpGlow);
                drawPixelRect(x + 39, y + 33, 4, 6, warpGlow);
                
                // Warp field distortion effects
                if (warpField > 0.9) {
                    drawPixelRect(x + 5, y + 30, 8, 1, warpGlow);
                    drawPixelRect(x + 37, y + 30, 8, 1, warpGlow);
                    drawPixelRect(x + 5, y + 41, 8, 1, warpGlow);
                    drawPixelRect(x + 37, y + 41, 8, 1, warpGlow);
                }
            }
            
            // ENHANCED PLASMA TRAIL SYSTEM - Epic exhaust effects
            if (engineGlow > 0.4) {
                for (let i = 0; i < 20; i++) {
                    const trailIntensity = (20 - i) / 20;
                    const trailWidth = Math.floor(trailIntensity * 35) + 5;
                    const trailHeight = 3 + Math.floor(trailIntensity * 6);
                    const trailY = y + 80 + i * 4;
                    
                    if (trailY < introHeight) {
                        const alpha = trailIntensity * engineGlow;
                        const trailColor = alpha > 0.9 ? '#ffffff' : 
                                         alpha > 0.7 ? '#ffff00' : 
                                         alpha > 0.5 ? '#ff8800' : 
                                         alpha > 0.3 ? '#ff4400' : 
                                         alpha > 0.1 ? '#ff0000' : '#660000';
                        
                        drawPixelRect(
                            x + 25 - trailWidth/2, 
                            trailY, 
                            trailWidth, 
                            trailHeight, 
                            trailColor
                        );
                        
                        // Plasma distortion effects
                        if (i < 5 && alpha > 0.6) {
                            drawPixelRect(
                                x + 20 - trailWidth/3, 
                                trailY - 2, 
                                trailWidth/3, 
                                1, 
                                '#00ffff'
                            );
                            drawPixelRect(
                                x + 30 + trailWidth/3, 
                                trailY - 2, 
                                trailWidth/3, 
                                1, 
                                '#00ffff'
                            );
                        }
                    }
                }
            }
            
            // ADVANCED MANEUVERING THRUSTERS - RCS system
            const rcsActive = Math.random() > 0.7;
            if (rcsActive) {
                drawPixelRect(x + 10, y + 18, 2, 1, '#00ffff');
                drawPixelRect(x + 38, y + 18, 2, 1, '#00ffff');
                drawPixelRect(x + 24, y + 12, 2, 1, '#00ffff');
                drawPixelRect(x + 6, y + 30, 1, 2, '#00ffff');
                drawPixelRect(x + 43, y + 30, 1, 2, '#00ffff');
            }
            
            // STARFIGHTER HULL DETAILS - Military markings
            drawPixelRect(x + 24, y + 21, 2, 1, '#ffffff'); // Center line detail
            drawPixelRect(x + 20, y + 25, 2, 1, '#ffffff'); // Left marking
            drawPixelRect(x + 28, y + 25, 2, 1, '#ffffff'); // Right marking
            
            // Hull paneling and access ports
            for (let i = 0; i < 4; i++) {
                drawPixelRect(x + 18 + i*3, y + 29, 1, 1, '#dddddd');
                drawPixelRect(x + 19 + i*3, y + 32, 1, 1, '#dddddd');
            }
            
            // Squadron markings
            drawPixelRect(x + 22, y + 26, 6, 1, '#ff0000'); // Red stripe
            drawPixelRect(x + 23, y + 30, 4, 1, '#ffff00'); // Yellow stripe
            
            // QUANTUM CORE REACTOR - Central power source
            const coreColor = `hsl(120, 100%, ${60 + pulseEffect * 35}%)`;
            const coreSize = Math.floor(3 + pulseEffect * 2);
            drawPixelRect(x + 24, y + 28, coreSize, coreSize, coreColor);
            
            // Core energy containment field
            if (pulseEffect > 0.7) {
                drawPixelRect(x + 22, y + 27, coreSize + 4, 1, coreColor);
                drawPixelRect(x + 22, y + 32, coreSize + 4, 1, coreColor);
                drawPixelRect(x + 22, y + 27, 1, coreSize + 4, coreColor);
                drawPixelRect(x + 27, y + 27, 1, coreSize + 4, coreColor);
            }
            
            // Core overcharge effects
            if (pulseEffect > 0.9) {
                drawPixelRect(x + 23, y + 29, coreSize + 2, coreSize + 2, '#ffffff');
            }
            
            // DEFLECTOR ARRAY - Advanced sensors
            const deflectorColor = `hsl(30, 100%, ${50 + Math.sin(animationTime * 0.1) * 40}%)`;
            drawPixelRect(x + 22, y + 10, 6, 2, deflectorColor);
            
            // Sensor sweep beam
            if (Math.sin(animationTime * 0.08) > 0.6) {
                drawPixelRect(x + 24, y + 8, 2, 1, deflectorColor);
                drawPixelRect(x + 23, y + 6, 4, 1, deflectorColor);
            }
            
            // COMMUNICATION ARRAY - Long range comms
            drawPixelRect(x + 19, y + 15, 2, 1, '#00ff00');
            drawPixelRect(x + 29, y + 15, 2, 1, '#00ff00');
            
            // EMERGENCY SYSTEMS - Distress beacon
            if (Math.sin(animationTime * 0.18) > 0.7) {
                drawPixelRect(x + 24, y + 8, 2, 1, '#ff0000');
            }
            
            // STATUS LIGHTS - System indicators
            const systemStatus = Math.sin(animationTime * 0.07);
            if (systemStatus > 0.5) drawPixelRect(x + 18, y + 19, 1, 1, '#00ff00'); // Green - Systems OK
            if (systemStatus > 0.0) drawPixelRect(x + 31, y + 19, 1, 1, '#ffff00'); // Yellow - Caution
            if (systemStatus > -0.5) drawPixelRect(x + 25, y + 19, 1, 1, '#0080ff'); // Blue - Navigation
        }
        
        // Animate intro sequence
        function animateIntro() {
            // Clear canvas
            introCtx.fillStyle = '#000';
            introCtx.fillRect(0, 0, introWidth, introHeight);
            
            // Update and draw stars
            for (let star of introStars) {
                // Add current position to trail
                star.trail.push({ x: star.x, y: star.y });
                if (star.trail.length > 15) {
                    star.trail.shift();
                }
                
                // Move star
                star.y += star.speed * (1 + animationTime / ANIMATION_DURATION * 3);
                
                // Reset star if it goes off screen
                if (star.y > introHeight + 20) {
                    star.y = -20;
                    star.x = Math.random() * introWidth;
                    star.trail = [];
                }
                
                // Draw trail
                star.trail.forEach((point, index) => {
                    const alpha = index / star.trail.length;
                    const size = star.size * alpha;
                    if (size > 0.5) {
                        drawPixelRect(point.x, point.y, size, size * 2, star.color);
                    }
                });
                
                // Draw main star
                drawPixelRect(star.x, star.y, star.size, star.size * 3, star.color);
            }
            
            // Draw spaceship
            drawSpaceship();
            
            // Add screen shake effect near end
            if (animationTime > ANIMATION_DURATION - 1000) {
                const shake = Math.random() * 4 - 2;
                introCanvas.style.transform = `translate(${shake}px, ${shake}px)`;
            }
            
            animationTime += 16; // ~60fps
            
            if (animationTime < ANIMATION_DURATION) {
                introAnimationId = requestAnimationFrame(animateIntro);
            } else {
                endIntroAnimation();
            }
        }
        
        // Start intro animation (called after file upload)
        function startIntroAnimation() {
            if (animationStarted) return;
            animationStarted = true;
            
            // Hide upload section and show animation canvas
            uploadSection.classList.add('fade-out');
            
            setTimeout(() => {
                uploadSection.style.display = 'none';
                introCanvas.classList.add('show');
                
                // Reset animation variables
                animationTime = 0;
                createIntroStars();
                animateIntro();
            }, 1000);
        }
        
        // End intro animation and show button
        function endIntroAnimation() {
            introCanvas.style.transform = 'none';
            introCanvas.classList.add('fade-out');
            
            setTimeout(() => {
                introCanvas.style.display = 'none';
                showResultsBtn.classList.add('show');
            }, 1000);
        }
        
        // Show dashboard content
        function showDashboardResults() {
            showResultsBtn.classList.remove('show');
            
            // Start the spaceship animation again
            setTimeout(() => {
                showResultsBtn.style.display = 'none';
                
                // Reset and show intro canvas again
                introCanvas.style.display = 'block';
                introCanvas.style.opacity = '1';
                introCanvas.classList.remove('fade-out');
                
                // Reset animation variables for second playthrough
                animationTime = 0;
                animationStarted = false;
                
                // Create new stars for the animation
                createIntroStars();
                
                // Start the animation
                animateIntro();
                
                // After animation completes, show dashboard
                setTimeout(() => {
                    introCanvas.classList.add('fade-out');
                    setTimeout(() => {
                        introCanvas.style.display = 'none';
                        dashboardContent.classList.add('show');
                        initializeDashboard();
                    }, 1000);
                }, ANIMATION_DURATION + 500); // Wait for animation to complete plus buffer
                
            }, 500);
        }
        
        // Event listener for show results button
        showResultsBtn.addEventListener('click', showDashboardResults);
        
        window.addEventListener('resize', () => {
            introWidth = window.innerWidth;
            introHeight = window.innerHeight;
            introCanvas.width = introWidth;
            introCanvas.height = introHeight;
            spaceship.x = introWidth / 2 - 15;
            spaceship.y = introHeight - 60;
        });
        
        // ======= EXISTING VQE DASHBOARD CODE =======
        let vqeData = null;
        let currentVariant = null;
        
        // Color palette for the three variants: red, white, gray
        const variantColors = ['#FF0000', '#FFFFFF', '#888888'];
        
        // Custom cursor and background effects
        const cursor = document.getElementById('custom-cursor');
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        
        let mouse = { x: width/2, y: height/2 };
        let particles = [];
        const NUM_PARTICLES = 150;
        
        // Initialize particles
        function createParticles() {
            particles = [];
            for (let i = 0; i < NUM_PARTICLES; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    dx: (Math.random() - 0.5) * 2,
                    dy: (Math.random() - 0.5) * 2,
                    size: Math.random() * 6 + 2,
                    color: ['#fff', '#f00', '#888'][Math.floor(Math.random() * 3)]
                });
            }
        }
        createParticles();
        
        // Draw pixel-style particles
        function drawPixel(x, y, size, color) {
            ctx.fillStyle = color;
            ctx.fillRect(Math.round(x), Math.round(y), Math.round(size), Math.round(size));
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            ctx.strokeRect(Math.round(x), Math.round(y), Math.round(size), Math.round(size));
        }
        
        // Animate background
        function animateBg() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, width, height);
            
            for (let p of particles) {
                // Mouse interaction
                let dx = p.dx, dy = p.dy;
                let dist = Math.hypot(mouse.x - p.x, mouse.y - p.y);
                if (dist < 100) {
                    let angle = Math.atan2(p.y - mouse.y, p.x - mouse.x);
                    dx += Math.cos(angle) * (100 - dist) * 0.02;
                    dy += Math.sin(angle) * (100 - dist) * 0.02;
                }
                
                p.x += dx;
                p.y += dy;
                p.dx = dx * 0.98;
                p.dy = dy * 0.98;
                
                // Wrap around edges
                if (p.x < 0) p.x = width;
                if (p.x > width) p.x = 0;
                if (p.y < 0) p.y = height;
                if (p.y > height) p.y = 0;
                
                drawPixel(p.x, p.y, p.size, p.color);
            }
            requestAnimationFrame(animateBg);
        }
        animateBg();
        
        // Cursor tracking
        document.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
            cursor.style.left = `${e.clientX}px`;
            cursor.style.top = `${e.clientY}px`;
            
            // Update cursor spaceship
            drawCursorSpaceship(e.clientX, e.clientY);
        });
        
        document.addEventListener('mousedown', (e) => {
            cursor.classList.add('active');
            createExplosion(e.clientX, e.clientY);
        });
        
        document.addEventListener('mouseup', () => {
            cursor.classList.remove('active');
        });
        
        // Draw mini spaceship cursor
        function drawCursorSpaceship(x, y) {
            const cursorCanvas = document.createElement('canvas');
            cursorCanvas.width = 24;
            cursorCanvas.height = 32;
            const ctx = cursorCanvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, 24, 32);
            
            // Mini spaceship design
            // Nose (white)
            ctx.fillStyle = '#fff';
            ctx.fillRect(11, 0, 2, 3);
            
            // Body (silver/white)
            ctx.fillStyle = '#ddd';
            ctx.fillRect(10, 3, 4, 8);
            
            // Cockpit (blue)
            ctx.fillStyle = '#00aaff';
            ctx.fillRect(11, 4, 2, 3);
            
            // Wings (grey)
            ctx.fillStyle = '#888';
            ctx.fillRect(6, 9, 4, 2);
            ctx.fillRect(14, 9, 4, 2);
            
            // Wing tips (green)
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(5, 9, 1, 2);
            ctx.fillRect(18, 9, 1, 2);
            
            // Engine (red/orange)
            const engineFlicker = Math.random() > 0.5;
            ctx.fillStyle = engineFlicker ? '#ff0000' : '#ff8800';
            ctx.fillRect(9, 11, 2, 4);
            ctx.fillRect(13, 11, 2, 4);
            
            // Center engine
            ctx.fillStyle = engineFlicker ? '#ffff00' : '#ff0000';
            ctx.fillRect(11, 11, 2, 5);
            
            // Thruster trail
            if (Math.random() > 0.7) {
                ctx.fillStyle = '#ff4400';
                ctx.fillRect(10, 16, 4, 8);
                ctx.fillStyle = '#ff8800';
                ctx.fillRect(11, 20, 2, 8);
            }
            
            // Convert to data URL and set as cursor
            const dataURL = cursorCanvas.toDataURL();
            cursor.style.background = `url(${dataURL})`;
            cursor.style.backgroundSize = 'contain';
            cursor.style.backgroundRepeat = 'no-repeat';
            cursor.style.border = 'none';
        }
        
        // Create explosion effect
        function createExplosion(x, y) {
            const colors = ['#ff0000', '#ff8800', '#ffff00', '#ffffff', '#ff4400'];
            const particleCount = 12;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'explosion-particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                // Random direction and speed
                const angle = (i / particleCount) * Math.PI * 2 + (Math.random() - 0.5) * 0.5;
                const speed = Math.random() * 100 + 50;
                const size = Math.random() * 6 + 2;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                document.body.appendChild(particle);
                
                // Animate particle
                const startTime = Date.now();
                const duration = 800;
                
                function animateParticle() {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / duration;
                    
                    if (progress >= 1) {
                        particle.remove();
                        return;
                    }
                    
                    // Calculate position
                    const distance = speed * progress;
                    const particleX = x + Math.cos(angle) * distance;
                    const particleY = y + Math.sin(angle) * distance + (progress * progress * 200); // Gravity effect
                    
                    // Update position and fade
                    particle.style.left = `${particleX}px`;
                    particle.style.top = `${particleY}px`;
                    particle.style.opacity = 1 - progress;
                    particle.style.transform = `scale(${1 - progress * 0.5})`;
                    
                    requestAnimationFrame(animateParticle);
                }
                
                requestAnimationFrame(animateParticle);
            }
        }
        
        // Initialize cursor spaceship
        setTimeout(() => {
            drawCursorSpaceship(window.innerWidth / 2, window.innerHeight / 2);
        }, 100);
        
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            createParticles();
        });
        
        // File handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const fileStatus = document.getElementById('fileStatus');
        
        // Drag and drop functionality
        // Load actual NEBULA VQE data from your file
        function loadNEBULAData() {
            const actualData = [
                {
                    "variant": "Cell 4 HEA (100 SPSA, zero-init)",
                    "final_energy": -57.23148566678536,
                    "best_energy": -58.225980682324014,
                    "iterations": 251,
                    "num_parameters": 1,
                    "parameters": [0.0],
                    "energy_history": [
                        5.689893001203927e-16, -1.6790244362953624, -1.7616595353385205, -0.3735850790202177,
                        -2.5365284056013153, -1.2419797763874918, -31.65382525436657, -34.05057640023469,
                        -28.383474407907094, -22.13193052645232, -21.417716477225593, -23.718559680955405,
                        -37.88443755596072, -38.17906623227948, -37.229459829834916, -38.03487702034878,
                        -38.23361416704576, -37.943456518088574, -38.189439999272636, -36.38865405141196,
                        -39.40210596793508, -34.43310073550563, -32.171623101862025, -36.376044714066154,
                        -43.74674438173371, -46.62955853922431, -40.53388784866436, -30.78291162521346,
                        -32.43955822609655, -29.778076639078055, -44.664148874047356, -44.05721029696029,
                        -44.978553025020524, -45.09146710985913, -46.84277244084308, -43.45961659987352,
                        -52.84236269575883, -50.85430595060592, -53.385690109798865, -44.50218330416334,
                        -45.14816281458576, -43.58619901311337, -45.56170065549188, -43.85067567483023,
                        -45.832204966568604, -40.63196361504286, -41.4275860479872, -40.030187361305615,
                        -42.461692844707315, -42.66851981645012, -42.1151031327125, -42.667451662086414,
                        -42.31931352567231, -42.96533332035794, -42.99437290621846, -44.28868019747107,
                        -41.305809086663714, -43.31620508798918, -42.84679635206406, -43.49284136567539,
                        -43.487612322840285, -41.1508296169622, -45.351866582103355, -40.01352146323735,
                        -40.28788772994082, -39.57466844645549, -40.31426085647416, -37.427147471790335,
                        -42.20816458303826, -36.55994442372629, -36.74169751151067, -37.27139784047569,
                        -37.094679593577425, -37.85240572627703, -36.70918930427457, -38.614896992013335,
                        -39.47035414186038, -38.6314202534372, -39.82612216476691, -41.54869343244587,
                        -38.37604098503804, -45.20327374922228, -43.54852136085076, -46.418657787417104,
                        -44.745773402102955, -42.99687441613264, -45.22708208266091, -42.998769970070214,
                        -44.07918671744361, -42.238493448719865, -46.101281230211576, -45.35061541557278,
                        -46.154044989467785, -46.10725927831802, -45.86477842413581, -46.229893758978356,
                        -46.1768777330472, -44.982003622960676, -47.204315471755315, -48.38770819524986,
                        -49.33342117597816, -47.75485113723479, -50.72202469272938, -50.890790590028,
                        -49.79234670995999, -50.7075791465609, -50.07192490615989, -51.01788230002681,
                        -51.030980392581405, -51.050363578127204, -50.67848996386565, -51.083416932645726,
                        -51.73017361578887, -50.24498613568035, -52.089476553369046, -51.01618741556548,
                        -52.91279048439344, -53.671073615799095, -53.9312010242299, -52.97532456612371,
                        -53.92123189477604, -53.66016830094684, -52.47722709272875, -52.84236695990483,
                        -51.55661142756231, -53.84798899305084, -54.34841610647321, -51.305802353914046,
                        -56.32286766686008, -49.227192852837334, -49.08678792459387, -48.83848138728789,
                        -49.23488249696705, -46.52375266105918, -50.6229024340757, -45.708033940754575,
                        -47.271711888946186, -43.89149670808742, -48.92957102618619, -46.30394208475522,
                        -50.71850857848571, -47.686770147645824, -47.28071787327564, -47.74977624244063,
                        -47.76010595603973, -45.00254830324106, -50.117357918677946, -47.20461968007563,
                        -46.984267189787964, -47.177724474802716, -47.21514052662375, -49.546137320838504,
                        -44.262172699901924, -46.37364975846579, -49.11291388164851, -43.61038681012444,
                        -46.67916680683966, -43.89814543032215, -48.84134483552489, -49.15666913903451,
                        -48.232059557598205, -49.34304015808527, -49.28883363536749, -48.7876859063848,
                        -49.164365483865815, -49.30871252223761, -47.711390178418974, -50.70989406669908,
                        -53.2934881268482, -53.12246085313988, -52.75617654298001, -53.31583620409917,
                        -51.71127584128991, -54.54229591058959, -55.2669896449179, -54.914134555635556,
                        -55.34475707464635, -55.345775405665755, -54.15360262364891, -55.87447338030507,
                        -55.652874306915976, -56.399864231207, -53.70860943186392, -54.55726639860715,
                        -55.31349239997384, -53.09605587212475, -54.902051802939134, -54.76034975605484,
                        -54.12738681223649, -54.91631122113964, -54.49274630354061, -55.02003727391619,
                        -55.01774571149776, -54.38765957601919, -54.70735737762385, -55.01533052728332,
                        -54.66826185219511, -54.15050006659585, -54.98563476698142, -54.86155075158973,
                        -54.22377553034504, -55.005654840521316, -55.10524706123674, -53.39720394305693,
                        -54.23105965443294, -54.96120064876873, -52.64942201955948, -54.69037703882686,
                        -54.242396305204515, -54.710226034473926, -54.75409706721636, -54.19298535625166,
                        -54.64543246618797, -54.78874212371136, -54.818591909123164, -53.81543432432297,
                        -54.815057306418296, -52.96095590524242, -55.24040626135447, -53.486485393551,
                        -55.37334884556797, -51.327160415952584, -57.23148566678536, -58.225980682324014,
                        -55.034230545075765, -55.80725389157272, -54.763568453253704, -56.265196711318154,
                        -56.262714367225605, -53.347304945013974, -57.89422813472282, -53.64710017244518,
                        -55.328158719058095, -51.56378127586897, -56.187188521190436, -54.19931161653846,
                        -57.08365940350865, -56.20173994051965, -56.4437181335674, -54.63898627363317,
                        -55.80463557469316, -56.466487218315926, -54.46550462469354, -56.55375638257443,
                        -56.74356091707266, -55.80087991105085, -56.75473514420178, -56.2878399161889,
                        -56.443117994623, -56.75487769763478, -57.23148566678536
                    ],
                    "improvement": 58.225980682324014,
                    "runtime": null
                },
                {
                    "variant": "Cell 5 HEA (200 SPSA, zero-init)",
                    "final_energy": -54.7843182392645,
                    "best_energy": -55.559230545889854,
                    "iterations": 266,
                    "num_parameters": 12,
                    "parameters": [0.273956, -0.061122, 0.358598, 0.197368, -0.405823, 0.475622, 0.26114, 0.286064, -0.371886, -0.049614, -0.129202, 0.426765],
                    "energy_history": [
                        5.689893001203927e-16, -1.7821163124976325, -1.6758003964194983, -0.6225063812315771,
                        -1.1644160574710183, -2.647783457160026, -18.698940715055937, -18.856332481979088,
                        -19.34013868567249, -20.391339188862844, -21.443885436166887, -20.117768662254846,
                        -29.44377534205872, -26.934469290661156, -31.82453515274981, -25.2358519835585,
                        -26.15714843394744, -25.15269352990647, -30.046049720570384, -27.6246845244642,
                        -32.56164595970935, -28.359926525981717, -28.194622661955794, -27.23202878524424,
                        -26.2939546524097, -25.686207290301994, -26.51717176071601, -26.38456384320319,
                        -26.653869156947163, -26.12434473112863, -26.695568468136777, -27.354332742882065,
                        -26.855750196550503, -27.418244499223032, -28.810655118250562, -25.7139181781781,
                        -15.233171470010653, -18.733525735527987, -13.143022101566482, -46.48834966089431,
                        -44.88346524404314, -46.90898944768898, -41.529466609885255, -38.29303139234275,
                        -44.01938900530578, -34.027017321322, -36.39899879731025, -31.766426830917577,
                        -46.77489039608736, -44.479054532280266, -48.33473089198426, -39.785993760545594,
                        -40.90270099110013, -37.46670394188221, -36.46442034574096, -35.31562961884621,
                        -38.1051550365121, -40.522903886525036, -40.3620864532333, -40.55511474858245,
                        -40.54386112930788, -40.8110665805914, -39.701330034847686, -40.674744233382455,
                        -42.909023865902434, -38.533852293386424, -39.68177895409928, -40.67113149346304,
                        -38.58095382692043, -41.600239312473136, -41.5250011901708, -41.56453148624308,
                        -41.60217705387232, -41.38463330708593, -41.972690629357494, -41.92788124641658,
                        -38.96919026525841, -45.22287379807133, -45.05236412606361, -41.55298646875539,
                        -47.68592335547759, -34.71190915362025, -36.24179512277906, -33.63069802478097,
                        -41.463041548705036, -39.84679901930235, -42.550571992182334, -39.761653925126055,
                        -39.854695225493174, -40.22625658759353, -39.91603048513819, -35.996280367797226,
                        -43.62835551811437, -38.58159848735531, -36.40744562112322, -40.185108634591195,
                        -42.957727899542654, -42.16700324294666, -43.70401425268276, -44.33736727648189,
                        -41.89955792186201, -46.32057356941225, -41.55801054361386, -41.267010345826115,
                        -41.8132259763667, -41.753316430273955, -39.65811252503856, -43.19174312559915,
                        -40.75361535161248, -41.56276231813962, -40.271173569493115, -42.18942792166872,
                        -41.18909052815985, -42.910165221617746, -43.199085495418544, -43.25194989484453,
                        -43.06038584571632, -43.21870678699314, -42.51890703994456, -44.082744267801324,
                        -44.981800451277756, -47.26045510260278, -42.2238619760204, -43.15483916957825,
                        -45.16119198539662, -40.802868913815196, -46.593075490959826, -46.740590048693775,
                        -46.04256514296012, -46.74225872436059, -46.8365538930877, -46.28887096677176,
                        -46.85720699502574, -46.12238090579677, -47.121312300990006, -47.10463073390108,
                        -46.68938887357583, -47.616382814792104, -47.678397894028976, -48.33829980599541,
                        -46.459125049392185, -48.28505059419131, -49.137827757076266, -47.198820610506154,
                        -49.82613934992388, -49.98463345825349, -49.34219073100372, -49.97825054567184,
                        -49.29820303663634, -50.47490134060208, -50.60440461692011, -49.422618871658116,
                        -51.27094946421967, -51.35727299056346, -51.38738381860176, -50.268239719921866,
                        -51.21279785551843, -51.706622420007534, -50.55422379224591, -51.817584294991164,
                        -51.30730448254922, -51.4526734398211, -51.82154140494365, -52.01434172721408,
                        -51.486116705666454, -51.9532804483428, -50.75343877424873, -51.863853082602176,
                        -51.64702610698536, -50.805331838281035, -51.92183473019025, -51.9062531519572,
                        -52.461074866621985, -50.75913681737778, -52.38897000918747, -51.7956540763663,
                        -52.59597071552873, -52.59167859668194, -51.74676048804884, -51.982617547027935,
                        -52.571460107869456, -51.35613943402512, -52.804615275229736, -52.47693996689824,
                        -51.98305110054833, -51.8607231785565, -52.47394181083296, -53.39881934374227,
                        -51.28479068833587, -54.01412156969996, -54.25966308310516, -53.25842822729816,
                        -54.257453075189595, -53.403849207938656, -53.85948697717549, -54.2270717299107,
                        -53.86233934846947, -54.16111760228371, -54.25453968954909, -53.3716469219577,
                        -53.81933377810353, -54.22422539099457, -53.164682374084926, -53.93682260578193,
                        -54.102987987264726, -53.96367500696791, -52.984653257103844, -53.96371004280294,
                        -53.1267058394437, -54.30668327902778, -54.315919396734145, -53.716990328333914,
                        -54.468095268625476, -54.47519251256031, -54.20532282883156, -53.57266356200099,
                        -54.434652415934444, -54.071770714018854, -54.40429286948386, -54.46935997702341,
                        -53.7382035533911, -54.734388236261076, -54.73445876378188, -54.043950315119986,
                        -54.175695836463944, -54.7322670693175, -54.98419417345716, -53.41448660400621,
                        -54.59968217030018, -54.33705779544704, -54.46401422189279, -54.60476796689754,
                        -53.99793934374848, -54.79286604289329, -54.78156886435169, -54.62110847627622,
                        -54.543624024947526, -54.7843182392645, -55.26238454238206, -53.16576966113779,
                        -54.62236141843784, -53.461173820673096, -54.79043949086399, -54.660072619818926,
                        -54.7363887988201, -53.70856742653743, -54.743610385727365, -54.47831921268563,
                        -53.70980443982553, -54.67538700047083, -55.559230545889854, -52.693817996886395,
                        -54.25421444515134, -54.13105674644693, -53.97619564215694, -54.26345720533383,
                        -55.202796179214765, -52.204660211067164, -53.88185323298953, -52.993778001330554,
                        -54.45374964625662, -54.555470686100065, -54.331489044285036, -54.3543777821614,
                        -54.55572041238334, -54.7843182392645
                    ],
                    "improvement": 55.559230545889854,
                    "runtime": null
                },
                {
                    "variant": "Cell 6 Hybrid (SPSA->COBYLA)",
                    "final_energy": -45.18899970394096,
                    "best_energy": -56.342329522013294,
                    "iterations": 75,
                    "num_parameters": 8,
                    "parameters": [0.0038085828848248094, -0.03502558321848972, 0.02459935132727304, 0.005585605188340428, 0.01662038775475136, -0.043260537803816244, -0.016787926256808326, 0.023233441799995102],
                    "energy_history": [
                        -56.342329522013294, -54.06322170839769, -54.317142777298045, -53.864306568603425,
                        -54.513667723844556, -50.72694685705871, -41.87706283049956, -43.77688118331188,
                        -40.58555082454783, -50.91836473510881, -51.22405388231284, -49.08981305205844,
                        -45.65507541603426, -44.745602100129084, -46.96267194773352, -45.7251578124662,
                        -47.06868583789642, -45.513267001045854, -44.552453495441874, -46.05608151829317,
                        -42.83672811469646, -39.716835218833424, -39.97706250815843, -38.838528778564296,
                        -39.469964646556015, -39.96251818656763, -39.1859283053505, -40.15860586886291,
                        -40.05432193531276, -40.36789094378947, -40.27433051448098, -39.789888457464116,
                        -40.715054033133065, -40.95581463109938, -41.232381593257145, -40.685203071889035,
                        -41.17903345784912, -40.618620553270624, -42.34445155400069, -45.54483033745988,
                        -43.72160461262131, -47.343524745224094, -53.60766890354371, -54.365123573049004,
                        -51.48050744674328, -49.50811081256772, -46.68689342645191, -51.83633536046464,
                        -52.629605459221956, -51.05323139161261, -53.293488664435564, -50.88286422708172,
                        -47.908152181251026, -52.74781722902481, -46.80305391182035, -46.235281253874945,
                        -47.57759162597141, -47.93598491238955, -47.29493099463868, -47.663430681163085,
                        -47.91425943941442, -47.702306757025205, -47.29766650131051, -47.9160047536728,
                        -44.56058630325927, -50.96357646748399, -43.772898081562346, -43.22739964021856,
                        -44.198733174721205, -44.300731659351385, -44.694559012447144, -43.96962550356228,
                        -44.658570050329175, -44.227868227963604, -45.18899970394096
                    ],
                    "improvement": 0.0,
                    "runtime": null
                },
                {
                    "variant": "Cell 7 Hybrid+ZNE (SPSA->COBYLA)",
                    "final_energy": -56.35304020650924,
                    "best_energy": -56.35304020650924,
                    "iterations": 180,
                    "num_parameters": 8,
                    "parameters": [0.0038085828848248094, -0.03502558321848972, 0.02459935132727304, 0.005585605188340428, 0.01662038775475136, -0.043260537803816244, -0.016787926256808326, 0.023233441799995102],
                    "energy_history": [
                        -56.32792098429779, -53.65210855704927, -54.59876526531309, -50.792521824400126,
                        -51.28092768405029, -47.81804300819827, -36.01929778328068, -33.146623630316434,
                        -37.839986975090454, -39.21319634419406, -39.4988916738804, -39.15811136709927,
                        -39.449133975638695, -43.3582070048966, -34.29803218170005, -25.479975616195023,
                        -29.835294899561728, -23.503999361280187, -28.632219341090394, -28.536883186868344,
                        -31.71411146441715, -35.1470513239273, -30.66582192667944, -38.969818253689674,
                        -36.25745721924849, -35.262713214002055, -36.00232791870576, -35.56840402086917,
                        -36.637495805625136, -33.35158552197486, -26.18429817214841, -26.36642617034506,
                        -26.48928377201413, -26.194900688030277, -28.600987532793823, -24.614465737037108,
                        -43.20169230928193, -44.19491122998122, -42.23576601394678, -45.37577233166637,
                        -46.12342167880049, -44.02497846946837, -44.64385465593171, -46.15042478704686,
                        -42.90771993744195, -43.05156771294187, -41.27301383205615, -44.07331935519808,
                        -42.605060227571684, -46.52743495040007, -38.64680573067615, -44.571749835194304,
                        -44.91676645594689, -43.608503250978906, -44.835482683345276, -46.78317205635745,
                        -43.18816578049073, -44.76081677357339, -44.35490073010303, -45.04996879007195,
                        -45.03128794753117, -46.76977193928081, -42.93929014744318, -46.77571688030294,
                        -48.375263984971575, -45.504216754039064, -53.149935542588786, -51.58484050354964,
                        -54.49961547406097, -53.07573443345675, -54.55460605598681, -51.15769044225321,
                        -52.656692194829134, -50.74997791782081, -53.694442229418954, -52.908261132568484,
                        -52.06992173796025, -53.4385048328309, -53.586845528201025, -52.33956677088063,
                        -53.83028539151722, -53.467341297073254, -53.62117157440387, -52.45027655317445,
                        -53.46128285811451, -51.834064126213846, -54.767002910495194, -55.04319334113693,
                        -54.683733993503495, -54.71428339806734, -55.04160369607839, -54.094159759781725,
                        -55.52747661952916, -55.54731366896165, -55.651972243523666, -54.39157364242552,
                        -55.38557682140523, -54.440330658626166, -55.438454189186174, -55.410425936771254,
                        -54.8551836197074, -55.433136680723145, -55.49950683823803, -55.05665526400204,
                        -55.15445274287716, -55.49183669241497, -55.160448191308284, -55.06516085121117,
                        -55.49976640767873, -54.342299915685906, -55.69779307120124, -55.50189709680065,
                        -54.257990926347475, -55.66849220006734, -55.444415673656806, -55.081616270112434,
                        -55.26187076351444, -55.45503189856762, -54.93704333381854, -55.19379786289718,
                        -55.47027762411771, -56.32792098429779, -55.79948538777711, -56.30688475963949,
                        -55.7543261098597, -56.30349762226733, -55.04640793459455, -55.74881866950493,
                        -55.55996574593589, -56.23171026599024, -55.252686361668545, -56.044495419335114,
                        -56.23719638706839, -56.31874221386882, -56.314325479420134, -56.32793964113389,
                        -56.32686466051869, -56.32805853995601, -56.327974854521884, -56.33101462656881,
                        -56.33493124260956, -56.33851149664615, -56.33469127912516, -56.33668494403967,
                        -56.33897785362601, -56.33054874688796, -56.333822021486505, -56.32910986734553,
                        -56.33455184380939, -56.34456423861418, -56.337972955169825, -56.34481417706321,
                        -56.34358919827952, -56.34255953054391, -56.33499246566737, -56.34290784429318,
                        -56.347394599560246, -56.335804077790655, -56.34563849271357, -56.35086042221006,
                        -56.349473886125814, -56.350454797034516, -56.34552365377825, -56.350464381746676,
                        -56.351044775009925, -56.34902985721455, -56.350903700156366, -56.35127239309837,
                        -56.35160456599651, -56.35206300953755, -56.35230664054335, -56.352490694527965,
                        -56.35260432322921, -56.3524821281055, -56.35243644608251, -56.35277001538914,
                        -56.35281994828731, -56.35281174922854, -56.35274600477446, -56.35304020650924
                    ],
                    "improvement": 0.02511922221145113,
                    "runtime": null
                },
                {
                    "Hamiltonian_Terms_First10": [
                        "-34.39753181 * IIIIII",
                        "+2.40316023 * IIIIZI",
                        "+11.07956840 * IIIIIZ",
                        "+0.19849215 * IIIIZZ",
                        "+2.03924408 * IIIZII",
                        "+0.17564461 * IIIZIZ",
                        "+0.12761114 * IIIIYY",
                        "+0.00469314 * IIIZYY",
                        "+0.12761114 * IIIIXX",
                        "+0.00469314 * IIIZXX"
                    ]
                },
                {
                    "ZNE_analysis": {
                        "total_applications": 180,
                        "average_improvement": 2.5855860662381422e-15,
                        "std_improvement": 4.537819054610257e-15,
                        "max_improvement": 1.4210854715202004e-14,
                        "min_improvement": 0.0,
                        "extrapolation_method": "richardson",
                        "noise_factors": [1.0, 3.0, 5.0],
                        "success_rate": 27.77777777777778
                    }
                }
            ];

            // Set the data globally
            window.vqeRawData = actualData;
            vqeData = actualData.filter(item => item.variant && item.energy_history);

            console.log('Loaded NEBULA VQE data:', actualData);
            showMessage('NEBULA VQE data loaded successfully!', 'success');
            initializeDashboard();
        }

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        uploadArea.addEventListener('click', () => {
        // Only the button opens the file dialog now
        document.getElementById('uploadBtn').addEventListener('click', () => {
            fileInput.click();
        });
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showMessage('Please select a JSON file.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('File loaded successfully:', data);
                    
                    // Store raw data globally but don't process yet
                    window.uploadedData = data;
                    
                    // Show success message and reveal start button
                    showMessage(`File uploaded successfully! Click "START ANALYSIS" to begin.`, 'success');
                    document.getElementById('startBtn').style.display = 'inline-block';
                    
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showMessage(`Error loading file. Please check the JSON format.`, 'error');
                    document.getElementById('startBtn').style.display = 'none';
                }
            };
            reader.readAsText(file);
        }
        
        function processUploadedData() {
            if (!window.uploadedData) {
                showMessage('No data to process. Please upload a JSON file first.', 'error');
                return;
            }
            
            try {
                const data = window.uploadedData;
                
                // Store raw data globally for accessing ZNE_analysis
                window.vqeRawData = data;
                
                // Handle different data formats - filter out non-variant objects
                if (Array.isArray(data)) {
                    // Filter out ZNE_analysis and other non-variant objects
                    vqeData = data.filter(item => item.variant && item.energy_history);
                } else if (data.results && Array.isArray(data.results)) {
                    vqeData = data.results.filter(item => item.variant && item.energy_history);
                } else {
                    throw new Error('Invalid data format. Expected array with VQE variant objects.');
                }
                
                if (vqeData.length === 0) {
                    throw new Error('No valid VQE variants found in the data.');
                }
                
                showMessage(`Processing ${vqeData.length} VQE variants...`, 'success');
                
                // Hide the start button and start intro animation
                document.getElementById('startBtn').style.display = 'none';
                
                // Start intro animation after successful processing
                setTimeout(() => {
                    startIntroAnimation();
                }, 1500);
                
            } catch (error) {
                console.error('Error processing data:', error);
                showMessage(`Error processing data: ${error.message}`, 'error');
            }
        }
        
        function showMessage(message, type) {
            const className = type === 'error' ? 'error-message' : 'success-message';
            fileStatus.innerHTML = `<div class="${className}">${message}</div>`;
        }
        
        function initializeDashboard() {
            document.getElementById('loadingMessage').style.display = 'none';
            
            // Add all the dashboard content
            dashboardContent.innerHTML = `
                <div class="dashboard-grid">
                    <!-- 1. NH3 Molecular Model - 3D Render -->
                    <div class="card full-width">
                        <h3 class="card-title">MOLECULAR STRUCTURE VIEWER</h3>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; height: 400px; align-items: center;">
                            <!-- Left side - Big NEBULA text -->
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                                <div style="
                                    font-size: 6em;
                                    color: #fff;
                                    text-shadow: 4px 4px 0 #f00, 8px 8px 0 #000;
                                    letter-spacing: 8px;
                                    margin-bottom: 20px;
                                    font-weight: bold;
                                    animation: pulse 2s infinite;
                                ">NEBULA</div>
                                <div style="
                                    font-size: 1.2em;
                                    color: #ccc;
                                    text-align: center;
                                    line-height: 1.4;
                                    text-shadow: 1px 1px 0 #000;
                                    margin-bottom: 20px;
                                ">
                                    Enhanced VQE Analysis<br>
                                    Quantum Chemistry Simulation<br>
                                    <span id="current-molecule-name">NH Molecular System</span>
                                </div>
                                
                                <!-- Molecule Selector -->
                                <div style="margin-top: 20px;">
                                    <label style="color: #fff; font-size: 0.8em; margin-bottom: 10px; display: block;">SELECT MOLECULE:</label>
                                    <select id="moleculeSelect" style="
                                        background: #000;
                                        color: #fff;
                                        border: 2px solid #f00;
                                        padding: 10px 15px;
                                        font-family: 'Press Start 2P', monospace;
                                        font-size: 0.7em;
                                        width: 250px;
                                        cursor: pointer;
                                    ">
                                        <option value="nh3">NH (Ammonia)</option>
                                        <option value="h2">H (Hydrogen)</option>
                                        <option value="lih">LiH (Lithium Hydride)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Right side - 3D Model -->
                            <div style="height: 400px; position: relative;">
                                <div class="molecular-viewer" style="height: 100%; border: 2px solid #f00; background: rgba(0, 0, 0, 0.9);">
                                    <canvas id="nh3-canvas"></canvas>
                                    <div class="molecular-info" style="font-size: 0.7em;" id="molecular-info">
                                        <div><strong>Formula:</strong> NH (Ammonia)</div>
                                        <div><strong>Geometry:</strong> Trigonal Pyramidal</div>
                                        <div><strong>Bond Angle:</strong> ~107</div>
                                        <div><strong>N-H Bond Length:</strong> ~1.01 </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 2. Hamiltonian Decomposition -->
                    <div class="card full-width">
                        <h3 class="card-title">HAMILTONIAN DECOMPOSITION</h3>
                        <div class="hamiltonian-container" id="hamiltonianTerms">
                            <!-- Hamiltonian terms will be populated here -->
                        </div>
                    </div>
                    
                    <!-- 3. Parameter Analysis -->
                    <div class="card full-width">
                        <h3 class="card-title">PARAMETER ANALYSIS</h3>
                        <div class="plot-container" id="parameterPlot"></div>
                    </div>
                    
                    <!-- 4. Individual Variant Analysis -->
                    <div class="card full-width">
                        <h3 class="card-title">INDIVIDUAL VARIANT ANALYSIS</h3>
                        <div class="variant-selector">
                            <select id="variantSelect">
                                <option value="">Select a variant...</option>
                            </select>
                        </div>
                        <div class="plot-container energy-convergence" style="height: 500px;" id="convergencePlot"></div>
                    </div>
                    
                    <!-- 5. Energy Convergence All Variants -->
                    <div class="card full-width">
                        <h3 class="card-title">ENERGY CONVERGENCE - ALL VARIANTS</h3>
                        <div class="plot-container" style="height: 500px;" id="convergencePlotAll"></div>
                    </div>
                    
                    <!-- 6. Improvement Percentage -->
                    <div class="card">
                        <h3 class="card-title">IMPROVEMENT PERCENTAGE</h3>
                        <div class="highlight-stat" id="improvementStat">
                            <span class="stat-big-value">--</span>
                            <div class="stat-label">Energy Improvement</div>
                        </div>
                    </div>
                    
                    <!-- 7. ZNE Success Rate -->
                    <div class="card">
                        <h3 class="card-title">ZNE SUCCESS RATE</h3>
                        <div class="highlight-stat" id="zneSuccessStat">
                            <span class="stat-big-value">--</span>
                            <div class="stat-label">Noise Mitigation Success</div>
                        </div>
                    </div>
                    
                    <!-- 8. Summary Statistics -->
                    <div class="card full-width">
                        <h3 class="card-title">SUMMARY STATISTICS</h3>
                        <div class="stats-grid" id="statsGrid">
                            <!-- Stats will be populated here -->
                        </div>
                        <table class="summary-table" id="summaryTable">
                            <thead>
                                <tr>
                                    <th>Variant</th>
                                    <th>Final Energy (Ha)</th>
                                    <th>Best Energy (Ha)</th>
                                    <th>Improvement (Ha)</th>
                                    <th>Iterations</th>
                                    <th>Parameters</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    
                    <!-- 9. Energy Comparison Across Variants -->
                    <div class="card full-width">
                        <h3 class="card-title">ENERGY COMPARISON ACROSS VARIANTS</h3>
                        <div class="plot-container comparison-chart" id="comparisonChart"></div>
                    </div>
                </div>
            `;
            
            populateVariantSelector();
            generateSummaryStats();
            renderSummaryTable();
            renderHamiltonianTerms();
            renderComparisonChart();
            renderAllVariantsConvergence();
            
            // Create NH3 molecular model
            setTimeout(() => {
                createNH3Model();
            }, 100);
            
            // Select first variant by default
            if (vqeData.length > 0) {
                document.getElementById('variantSelect').value = '0';
                selectVariant(0);
            }
        }
        
        function populateVariantSelector() {
            const select = document.getElementById('variantSelect');
            select.innerHTML = '<option value="">Select a variant...</option>';
            
            vqeData.forEach((variant, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = variant.variant || `Variant ${index + 1}`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', (e) => {
                if (e.target.value !== '') {
                    selectVariant(parseInt(e.target.value));
                }
            });
        }
        
        function selectVariant(index) {
            currentVariant = vqeData[index];
            renderConvergencePlot();
            renderParameterAnalysis();
        }
        
        function generateSummaryStats() {
            const statsGrid = document.getElementById('statsGrid');
            
            // Helper function to parse parameter count
            function getParameterCount(variant) {
                if (!variant.parameters) return 0;
                
                if (typeof variant.parameters === 'string') {
                    try {
                        const paramStr = variant.parameters.replace(/[\[\]]/g, '').trim();
                        return paramStr.split(/\s+/).filter(p => p.length > 0).length;
                    } catch (e) {
                        return 0;
                    }
                } else if (Array.isArray(variant.parameters)) {
                    return variant.parameters.length;
                } else {
                    return 0;
                }
            }
            
            // Calculate more useful VQE statistics
            const totalVariants = vqeData.length;
            
            // Find best performing variant
            const bestVariantEnergy = Math.min(...vqeData.map(v => v.best_energy || v.final_energy || 0));
            const bestVariant = vqeData.find(v => 
                (v.best_energy || v.final_energy) === bestVariantEnergy
            );
            
            // Calculate convergence efficiency (energy improvement per iteration)
            const convergenceEfficiencies = vqeData.map(v => {
                const energies = v.energy_history || [];
                if (energies.length < 2) return 0;
                const initialEnergy = energies[0];
                const finalEnergy = v.final_energy || v.best_energy || energies[energies.length - 1];
                const improvement = Math.abs(finalEnergy - initialEnergy);
                const iterations = v.iterations || energies.length;
                return iterations > 0 ? improvement / iterations : 0;
            });
            const avgConvergenceRate = convergenceEfficiencies.reduce((sum, eff) => sum + eff, 0) / convergenceEfficiencies.length;
            
            // Calculate average improvement percentage from variant data
            console.log('VQE Data:', vqeData);
            const improvements = vqeData.map(v => {
                console.log('Variant:', v.variant, 'Improvement:', v.improvement);
                return v.improvement || 0;
            });
            console.log('All improvements:', improvements);
            
            // Calculate average of all improvements (including 0.0)
            const avgImprovement = improvements.length > 0 ? 
                improvements.reduce((sum, imp) => sum + imp, 0) / improvements.length : 0;
            
            console.log('Average improvement calculated:', avgImprovement);
            
            // Get ZNE success rate from raw data
            let zneSuccessRate = 0;
            console.log('Raw data available:', !!window.vqeRawData);
            console.log('Raw data type:', typeof window.vqeRawData);
            if (window.vqeRawData && Array.isArray(window.vqeRawData)) {
                console.log('Searching for ZNE_analysis in', window.vqeRawData.length, 'items');
                window.vqeRawData.forEach((item, index) => {
                    console.log(`Item ${index}:`, Object.keys(item));
                });
                const zneAnalysis = window.vqeRawData.find(item => item.ZNE_analysis);
                console.log('ZNE Analysis found:', !!zneAnalysis);
                if (zneAnalysis && zneAnalysis.ZNE_analysis) {
                    zneSuccessRate = zneAnalysis.ZNE_analysis.success_rate || 0;
                    console.log('ZNE Success rate:', zneSuccessRate);
                }
            }
            
            // Check for hybrid optimization usage
            const hybridVariants = vqeData.filter(v => 
                v.variant && v.variant.includes('Hybrid')
            ).length;
            
            // Check for ZNE (Zero Noise Extrapolation) usage
            const zneVariants = vqeData.filter(v => 
                v.variant && v.variant.includes('ZNE')
            ).length;
            
            // Calculate total computational cost (sum of all iterations)
            const totalIterations = vqeData.reduce((sum, v) => sum + (v.iterations || 0), 0);
            
            const stats = [
                { 
                    label: 'Best Energy Found', 
                    value: bestVariantEnergy ? bestVariantEnergy.toFixed(6) + ' Ha' : 'N/A',
                    highlight: true
                },
                { 
                    label: 'Avg Improvement', 
                    value: avgImprovement > 0 ? avgImprovement.toFixed(2) + '%' : '0.00%'
                },
                { 
                    label: 'ZNE Success Rate', 
                    value: zneSuccessRate > 0 ? zneSuccessRate.toFixed(1) + '%' : '0.0%'
                },
                { 
                    label: 'Hybrid Methods', 
                    value: `${hybridVariants}/${totalVariants}`
                },
                { 
                    label: 'ZNE Enhanced', 
                    value: `${zneVariants}/${totalVariants}`
                },
                { 
                    label: 'Best Performer', 
                    value: 'Hybrid + ZNE'
                }
            ];
            
            console.log('Generated stats:', stats);
            
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-box ${stat.highlight ? 'highlight-box' : ''}">
                    <span class="stat-value">${stat.value}</span>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
            
            // Update the individual improvement and ZNE success rate cards
            const improvementStatElement = document.getElementById('improvementStat');
            const zneSuccessStatElement = document.getElementById('zneSuccessStat');
            
            if (improvementStatElement) {
                const improvementValue = avgImprovement > 0 ? avgImprovement.toFixed(1) + '%' : '--';
                improvementStatElement.querySelector('.stat-big-value').textContent = improvementValue;
                console.log('Updated improvement stat to:', improvementValue);
            }
            
            if (zneSuccessStatElement) {
                const zneValue = zneSuccessRate > 0 ? zneSuccessRate.toFixed(1) + '%' : '--';
                zneSuccessStatElement.querySelector('.stat-big-value').textContent = zneValue;
                console.log('Updated ZNE success stat to:', zneValue);
            }
        }
        
        function renderSummaryTable() {
            const tbody = document.querySelector('#summaryTable tbody');
            tbody.innerHTML = '';
            
            // Helper function to parse parameter count
            function getParameterCount(variant) {
                if (!variant.parameters) return 0;
                
                if (typeof variant.parameters === 'string') {
                    try {
                        const paramStr = variant.parameters.replace(/[\[\]]/g, '').trim();
                        return paramStr.split(/\s+/).filter(p => p.length > 0).length;
                    } catch (e) {
                        return 0;
                    }
                } else if (Array.isArray(variant.parameters)) {
                    return variant.parameters.length;
                } else {
                    return 0;
                }
            }
            
            vqeData.forEach(variant => {
                const energies = variant.energy_history || [];
                const finalEnergy = variant.final_energy || (energies.length > 0 ? energies[energies.length - 1] : 'N/A');
                const bestEnergy = variant.best_energy || (energies.length > 0 ? Math.min(...energies) : 'N/A');
                const improvement = variant.improvement || (energies.length > 1 ? energies[0] - bestEnergy : 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${variant.variant || 'Unknown'}</td>
                    <td>${typeof finalEnergy === 'number' ? finalEnergy.toFixed(8) : finalEnergy}</td>
                    <td>${typeof bestEnergy === 'number' ? bestEnergy.toFixed(8) : bestEnergy}</td>
                    <td>${typeof improvement === 'number' ? improvement.toFixed(6) : improvement}</td>
                    <td>${variant.iterations || 0}</td>
                    <td>${getParameterCount(variant)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function renderComparisonChart() {
            const traces = [];
            
            // Best energies comparison
            const variants = vqeData.map(v => v.variant || 'Unknown');
            const bestEnergies = vqeData.map(v => {
                return v.best_energy || (v.energy_history && v.energy_history.length > 0 ? Math.min(...v.energy_history) : null);
            });
            
            traces.push({
                x: variants,
                y: bestEnergies,
                type: 'bar',
                name: 'Best Energy',
                marker: { 
                    color: '#ff0000',
                    line: { color: '#ffffff', width: 2 }
                }
            });
            
            // Final energies comparison
            const finalEnergies = vqeData.map(v => {
                return v.final_energy || (v.energy_history && v.energy_history.length > 0 ? v.energy_history[v.energy_history.length - 1] : null);
            });
            
            traces.push({
                x: variants,
                y: finalEnergies,
                type: 'bar',
                name: 'Final Energy',
                marker: { 
                    color: '#ffffff',
                    line: { color: '#ff0000', width: 2 }
                }
            });
            
            // Calculate smart y-axis range to zoom in on differences
            const allEnergies = [...bestEnergies, ...finalEnergies].filter(e => e !== null);
            const minEnergy = Math.min(...allEnergies);
            const maxEnergy = Math.max(...allEnergies);
            const energyRange = maxEnergy - minEnergy;
            
            // Add 20% padding on each side, but ensure we see the differences
            const padding = Math.max(energyRange * 0.2, energyRange * 2); // At least 2x the range for better zoom
            const yMin = minEnergy - padding;
            const yMax = maxEnergy + padding;
            
            const layout = {
                title: {
                    text: 'Energy Comparison Across VQE Variants (Zoomed)',
                    font: { color: '#ffffff', size: 16, family: 'Press Start 2P' }
                },
                xaxis: { 
                    title: 'VQE Variant',
                    color: '#ffffff',
                    tickangle: -45,
                    tickfont: { family: 'Press Start 2P', size: 10 }
                },
                yaxis: { 
                    title: 'Energy (Hartree)',
                    color: '#ffffff',
                    tickfont: { family: 'Press Start 2P', size: 10 },
                    range: [yMin, yMax]  // Zoom in on the energy differences
                },
                plot_bgcolor: 'rgba(0,0,0,0.8)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', family: 'Press Start 2P' },
                legend: { 
                    font: { color: '#ffffff', family: 'Press Start 2P' },
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: '#ffffff',
                    borderwidth: 1
                },
                margin: { t: 50, b: 100, l: 80, r: 50 },
                annotations: [{
                    x: 0.5,
                    y: -0.25,
                    xref: 'paper',
                    yref: 'paper',
                    text: 'Y-axis zoomed to highlight energy differences',
                    showarrow: false,
                    font: { color: '#cccccc', size: 8, family: 'Press Start 2P' }
                }]
            };
            
            Plotly.newPlot('comparisonChart', traces, layout, { responsive: true });
        }
        
        function renderAllVariantsConvergence() {
            const traces = [];
            
            vqeData.forEach((variant, index) => {
                const energies = variant.energy_history || [];
                const iterations = Array.from({ length: energies.length }, (_, i) => i + 1);
                const variantName = variant.variant || `Variant ${index + 1}`;
                
                // Check if this is a hybrid variant with optimizer switch
                const isHybrid = (variantName.includes('Hybrid') || variantName.includes('hybrid')) && 
                               (variantName.includes('SPSA->COBYLA') || variantName.includes('spsa->cobyla'));
                const optimizerSwitch = variant.optimizer_switch;
                
                if (isHybrid && optimizerSwitch && optimizerSwitch.switched) {
                    // Split the trace at the switch point
                    const switchIteration = optimizerSwitch.switch_iteration;
                    
                    // Determine colors based on variant type
                    const isZNE = variantName.includes('ZNE') || variantName.includes('zne');
                    const spsaColor = isZNE ? '#ff8800' : '#ff4444'; // Orange for ZNE, Red for regular Hybrid
                    const cobylaColor = isZNE ? '#00ff88' : '#4444ff'; // Green for ZNE, Blue for regular Hybrid
                    
                    // SPSA phase (before switch)
                    const spsaIterations = iterations.slice(0, switchIteration);
                    const spsaEnergies = energies.slice(0, switchIteration);
                    
                    if (spsaIterations.length > 0) {
                        traces.push({
                            x: spsaIterations,
                            y: spsaEnergies,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${variantName} (SPSA)`,
                            line: { 
                                color: spsaColor,
                                width: 4,
                                shape: 'spline'
                            },
                            marker: { 
                                color: spsaColor, 
                                size: 8,
                                line: { color: '#000000', width: 2 },
                                symbol: 'square'
                            },
                            hovertemplate: '<b>%{fullData.name}</b><br>' +
                                          'Iteration: %{x}<br>' +
                                          'Energy: %{y:.8f} Ha<br>' +
                                          '<extra></extra>',
                            showlegend: true
                        });
                    }
                    
                    // COBYLA phase (after switch)
                    const cobylaIterations = iterations.slice(switchIteration);
                    const cobylaEnergies = energies.slice(switchIteration);
                    
                    if (cobylaIterations.length > 0) {
                        traces.push({
                            x: cobylaIterations,
                            y: cobylaEnergies,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${variantName} (COBYLA)`,
                            line: { 
                                color: cobylaColor,
                                width: 4,
                                shape: 'spline'
                            },
                            marker: { 
                                color: cobylaColor, 
                                size: 8,
                                line: { color: '#000000', width: 2 },
                                symbol: 'circle'
                            },
                            hovertemplate: '<b>%{fullData.name}</b><br>' +
                                          'Iteration: %{x}<br>' +
                                          'Energy: %{y:.8f} Ha<br>' +
                                          '<extra></extra>',
                            showlegend: true
                        });
                    }
                    
                } else if (isHybrid) {
                    // Hybrid variant but no switch occurred - use gradient colors to show intention
                    const spsa_iters = optimizerSwitch ? optimizerSwitch.configured_spsa_iters || 60 : 60;
                    const spsaIterations = iterations.slice(0, Math.min(spsa_iters, iterations.length));
                    const spsaEnergies = energies.slice(0, Math.min(spsa_iters, energies.length));
                    const cobylaIterations = iterations.slice(spsa_iters);
                    const cobylaEnergies = energies.slice(spsa_iters);
                    
                    // Determine colors based on variant type
                    const isZNE = variantName.includes('ZNE') || variantName.includes('zne');
                    const spsaColor = isZNE ? '#ffaa44' : '#ff6666'; // Light orange for ZNE, Light red for regular Hybrid
                    const cobylaColor = isZNE ? '#44ffaa' : '#6666ff'; // Light green for ZNE, Light blue for regular Hybrid
                    
                    // SPSA intended phase
                    if (spsaIterations.length > 0) {
                        traces.push({
                            x: spsaIterations,
                            y: spsaEnergies,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${variantName} (SPSA Phase)`,
                            line: { 
                                color: spsaColor,
                                width: 4,
                                shape: 'spline'
                            },
                            marker: { 
                                color: spsaColor, 
                                size: 8,
                                line: { color: '#000000', width: 2 },
                                symbol: 'square'
                            },
                            hovertemplate: '<b>%{fullData.name}</b><br>' +
                                          'Iteration: %{x}<br>' +
                                          'Energy: %{y:.8f} Ha<br>' +
                                          '<extra></extra>',
                            showlegend: true
                        });
                    }
                    
                    // COBYLA intended phase (even if switch didn't occur)
                    if (cobylaIterations.length > 0) {
                        traces.push({
                            x: cobylaIterations,
                            y: cobylaEnergies,
                            type: 'scatter',
                            mode: 'lines+markers',
                            name: `${variantName} (COBYLA Phase)`,
                            line: { 
                                color: cobylaColor,
                                width: 4,
                                shape: 'spline'
                            },
                            marker: { 
                                color: cobylaColor, 
                                size: 8,
                                line: { color: '#000000', width: 2 },
                                symbol: 'circle'
                            },
                            hovertemplate: '<b>%{fullData.name}</b><br>' +
                                          'Iteration: %{x}<br>' +
                                          'Energy: %{y:.8f} Ha<br>' +
                                          '<extra></extra>',
                            showlegend: true
                        });
                    }
                    
                } else {
                    // Non-hybrid variant - use original colors
                    traces.push({
                        x: iterations,
                        y: energies,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: variantName,
                        line: { 
                            color: variantColors[index % variantColors.length], 
                            width: 4,
                            shape: 'spline'
                        },
                        marker: { 
                            color: variantColors[index % variantColors.length], 
                            size: 8,
                            line: { color: '#000000', width: 2 },
                            symbol: ['square', 'circle', 'diamond'][index % 3]
                        },
                        hovertemplate: '<b>%{fullData.name}</b><br>' +
                                      'Iteration: %{x}<br>' +
                                      'Energy: %{y:.8f} Ha<br>' +
                                      '<extra></extra>'
                    });
                }
            });
            
            const layout = {
                title: {
                    text: 'Energy Convergence Comparison',
                    font: { color: '#ffffff', size: 18, family: 'Press Start 2P' }
                },
                xaxis: { 
                    title: 'Iteration',
                    color: '#ffffff',
                    showgrid: true,
                    gridcolor: 'rgba(255,255,255,0.2)',
                    tickfont: { family: 'Press Start 2P', size: 10 }
                },
                yaxis: { 
                    title: 'Energy (Hartree)',
                    color: '#ffffff',
                    showgrid: true,
                    gridcolor: 'rgba(255,255,255,0.2)',
                    tickfont: { family: 'Press Start 2P', size: 10 }
                },
                plot_bgcolor: 'rgba(0,0,0,0.8)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', family: 'Press Start 2P' },
                legend: { 
                    font: { color: '#ffffff', family: 'Press Start 2P' },
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: '#ffffff',
                    borderwidth: 1
                },
                margin: { t: 60, b: 60, l: 80, r: 50 },
                showlegend: true
            };
            
            Plotly.newPlot('convergencePlotAll', traces, layout, { responsive: true });
        }
        
        function renderConvergencePlot() {
            if (!currentVariant || !currentVariant.energy_history) return;
            
            const energies = currentVariant.energy_history;
            const iterations = Array.from({ length: energies.length }, (_, i) => i + 1);
            const variantName = currentVariant.variant || 'Energy';
            
            const traces = [];
            
            // Check if this is a hybrid variant with optimizer switch
            const isHybrid = (variantName.includes('Hybrid') || variantName.includes('hybrid')) && 
                           (variantName.includes('SPSA->COBYLA') || variantName.includes('spsa->cobyla'));
            const optimizerSwitch = currentVariant.optimizer_switch;
            
            if (isHybrid && optimizerSwitch && optimizerSwitch.switched) {
                // Split the trace at the switch point
                const switchIteration = optimizerSwitch.switch_iteration;
                
                // Determine colors based on variant type
                const isZNE = variantName.includes('ZNE') || variantName.includes('zne');
                const spsaColor = isZNE ? '#ff8800' : '#ff4444'; // Orange for ZNE, Red for regular Hybrid
                const cobylaColor = isZNE ? '#00ff88' : '#4444ff'; // Green for ZNE, Blue for regular Hybrid
                
                // SPSA phase (before switch)
                const spsaIterations = iterations.slice(0, switchIteration);
                const spsaEnergies = energies.slice(0, switchIteration);
                
                if (spsaIterations.length > 0) {
                    traces.push({
                        x: spsaIterations,
                        y: spsaEnergies,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'SPSA Phase',
                        line: { color: spsaColor, width: 3 },
                        marker: { 
                            color: spsaColor, 
                            size: 8,
                            line: { color: '#ffffff', width: 2 },
                            symbol: 'square'
                        }
                    });
                }
                
                // COBYLA phase (after switch)
                const cobylaIterations = iterations.slice(switchIteration);
                const cobylaEnergies = energies.slice(switchIteration);
                
                if (cobylaIterations.length > 0) {
                    traces.push({
                        x: cobylaIterations,
                        y: cobylaEnergies,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'COBYLA Phase',
                        line: { color: cobylaColor, width: 3 },
                        marker: { 
                            color: cobylaColor, 
                            size: 8,
                            line: { color: '#ffffff', width: 2 },
                            symbol: 'circle'
                        }
                    });
                }
                
            } else if (isHybrid) {
                // Hybrid variant but no switch occurred - use different colors for intended phases
                const spsa_iters = optimizerSwitch ? optimizerSwitch.configured_spsa_iters || 60 : 60;
                const spsaIterations = iterations.slice(0, Math.min(spsa_iters, iterations.length));
                const spsaEnergies = energies.slice(0, Math.min(spsa_iters, energies.length));
                const cobylaIterations = iterations.slice(spsa_iters);
                const cobylaEnergies = energies.slice(spsa_iters);
                
                // Determine colors based on variant type
                const isZNE = variantName.includes('ZNE') || variantName.includes('zne');
                const spsaColor = isZNE ? '#ffaa44' : '#ff6666'; // Light orange for ZNE, Light red for regular Hybrid
                const cobylaColor = isZNE ? '#44ffaa' : '#6666ff'; // Light green for ZNE, Light blue for regular Hybrid
                
                // SPSA intended phase
                if (spsaIterations.length > 0) {
                    traces.push({
                        x: spsaIterations,
                        y: spsaEnergies,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'SPSA Phase',
                        line: { color: spsaColor, width: 3 },
                        marker: { 
                            color: spsaColor, 
                            size: 8,
                            line: { color: '#ffffff', width: 2 },
                            symbol: 'square'
                        }
                    });
                }
                
                // COBYLA intended phase
                if (cobylaIterations.length > 0) {
                    traces.push({
                        x: cobylaIterations,
                        y: cobylaEnergies,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'COBYLA Phase',
                        line: { color: cobylaColor, width: 3 },
                        marker: { 
                            color: cobylaColor, 
                            size: 8,
                            line: { color: '#ffffff', width: 2 },
                            symbol: 'circle'
                        }
                    });
                }
                
            } else {
                // Non-hybrid variant - use original single trace
                traces.push({
                    x: iterations,
                    y: energies,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Energy',
                    line: { color: '#ff0000', width: 3 },
                    marker: { 
                        color: '#ff0000', 
                        size: 8,
                        line: { color: '#ffffff', width: 2 }
                    }
                });
            }
            
            const layout = {
                title: {
                    text: `Energy Convergence: ${variantName}`,
                    font: { color: '#ffffff', size: 14, family: 'Press Start 2P' }
                },
                xaxis: { 
                    title: 'Iteration',
                    color: '#ffffff',
                    tickfont: { family: 'Press Start 2P', size: 10 }
                },
                yaxis: { 
                    title: 'Energy (Hartree)',
                    color: '#ffffff',
                    tickfont: { family: 'Press Start 2P', size: 10 }
                },
                plot_bgcolor: 'rgba(0,0,0,0.8)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', family: 'Press Start 2P' },
                legend: isHybrid ? { 
                    font: { color: '#ffffff', family: 'Press Start 2P' },
                    bgcolor: 'rgba(0,0,0,0.8)',
                    bordercolor: '#ffffff',
                    borderwidth: 1
                } : {},
                margin: { t: 50, b: 50, l: 80, r: 50 }
            };
            
            Plotly.newPlot('convergencePlot', traces, layout, { responsive: true });
        }
        
        function renderParameterAnalysis() {
            const parameterContainer = document.getElementById('parameterPlot');
            
            // Helper function to parse parameters from string
            function parseParameters(paramString) {
                if (typeof paramString === 'string') {
                    try {
                        const paramStr = paramString.replace(/[\[\]]/g, '').trim();
                        return paramStr.split(/\s+/).filter(p => p.length > 0);
                    } catch (e) {
                        return [];
                    }
                } else if (Array.isArray(paramString)) {
                    return paramString;
                } else {
                    return [];
                }
            }
            
            // Create clean horizontal layout for parameters
            let parameterHTML = `
                <div style="
                    color: #fff; 
                    font-family: 'Press Start 2P', monospace; 
                    height: 100%; 
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    padding: 10px;
                    overflow-y: auto;
                ">
            `;
            
            vqeData.forEach((variant, index) => {
                const parameters = parseParameters(variant.parameters);
                const variantColors = ['#FF0000', '#FFFFFF', '#888888'];
                const variantColor = variantColors[index % 3];
                
                parameterHTML += `
                    <div style="
                        border: 2px solid ${variantColor}; 
                        background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,0,0,0.6));
                        padding: 12px;
                        border-radius: 5px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">
                        <!-- Clean Header -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 12px;
                            padding-bottom: 6px;
                            border-bottom: 1px solid ${variantColor};
                        ">
                            <span style="
                                color: ${variantColor}; 
                                font-size: 0.7em; 
                                text-shadow: 1px 1px 0 #000;
                                font-weight: bold;
                            ">
                                ${variant.variant || 'Unknown Variant'}
                            </span>
                            <span style="
                                color: #ccc; 
                                font-size: 0.6em;
                                background: rgba(${variantColor === '#FFFFFF' ? '255,255,255' : variantColor === '#FF0000' ? '255,0,0' : '136,136,136'}, 0.1);
                                padding: 2px 6px;
                                border-radius: 3px;
                            ">
                                ${parameters.length} Parameters
                            </span>
                        </div>
                        
                        <!-- Parameter Chips Container -->
                        <div style="
                            display: flex;
                            flex-wrap: wrap;
                            gap: 6px;
                            min-height: 40px;
                            max-height: 80px;
                            overflow-y: auto;
                            padding: 8px;
                            background: rgba(0,0,0,0.4);
                            border: 1px solid rgba(${variantColor === '#FFFFFF' ? '255,255,255' : variantColor === '#FF0000' ? '255,0,0' : '136,136,136'}, 0.3);
                            border-radius: 4px;
                        ">
                `;
                
                // Display parameters as clean chips
                parameters.forEach((param, paramIndex) => {
                    const paramValue = parseFloat(param);
                    const formattedParam = isNaN(paramValue) ? param : paramValue.toFixed(4);
                    
                    parameterHTML += `
                        <span style="
                            background: linear-gradient(135deg, rgba(${variantColor === '#FFFFFF' ? '255,255,255' : variantColor === '#FF0000' ? '255,0,0' : '136,136,136'}, 0.2), rgba(${variantColor === '#FFFFFF' ? '255,255,255' : variantColor === '#FF0000' ? '255,0,0' : '136,136,136'}, 0.1));
                            color: #fff;
                            padding: 3px 6px;
                            border: 1px solid ${variantColor};
                            border-radius: 3px;
                            font-size: 0.5em;
                            white-space: nowrap;
                            text-align: center;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                            transition: all 0.2s ease;
                        ">
                            ${formattedParam}
                        </span>
                    `;
                });
                
                parameterHTML += `
                        </div>
                    </div>
                `;
            });
            
            parameterHTML += '</div>';
            
            // Replace the plot container content with parameter values
            parameterContainer.innerHTML = parameterHTML;
            parameterContainer.style.height = '350px';
            parameterContainer.style.padding = '0';
            
            // Also log to console for debugging
            vqeData.forEach(v => {
                const params = parseParameters(v.parameters);
                console.log(`${v.variant} Parameters (${params.length}):`, params);
            });
        }
        
        function renderHamiltonianTerms() {
            const hamiltonianContainer = document.getElementById('hamiltonianTerms');
            
            // Find Hamiltonian data in the raw data - looking for "Hamiltonian_Terms_First10"
            const hamiltonianData = window.vqeRawData && Array.isArray(window.vqeRawData) ? 
                                   window.vqeRawData.find(item => item.Hamiltonian_Terms_First10) : null;
            
            if (!hamiltonianData || !hamiltonianData.Hamiltonian_Terms_First10) {
                hamiltonianContainer.innerHTML = `
                    <div style="text-align: center; color: #ccc; padding: 40px;">
                        No Hamiltonian terms found in the data
                    </div>
                `;
                return;
            }
            
            const terms = hamiltonianData.Hamiltonian_Terms_First10;
            
            // Calculate statistics
            const coefficients = terms.map(term => {
                const match = term.match(/^([+-]?\d+\.?\d*)/);
                return match ? parseFloat(match[1]) : 0;
            });
            
            const maxCoeff = Math.max(...coefficients.map(Math.abs));
            const minCoeff = Math.min(...coefficients.map(Math.abs).filter(x => x > 0));
            const avgCoeff = coefficients.reduce((sum, c) => sum + Math.abs(c), 0) / coefficients.length;
            
            let hamiltonianHTML = `
                <!-- Hamiltonian Statistics -->
                <div class="hamiltonian-stats">
                    <div class="hamiltonian-stat">
                        <span class="stat-value">${terms.length}</span>
                        <div class="stat-label">Total Terms</div>
                    </div>
                    <div class="hamiltonian-stat">
                        <span class="stat-value">${maxCoeff.toFixed(3)}</span>
                        <div class="stat-label">Max |Coefficient|</div>
                    </div>
                    <div class="hamiltonian-stat">
                        <span class="stat-value">${minCoeff.toFixed(6)}</span>
                        <div class="stat-label">Min |Coefficient|</div>
                    </div>
                    <div class="hamiltonian-stat">
                        <span class="stat-value">${avgCoeff.toFixed(3)}</span>
                        <div class="stat-label">Avg |Coefficient|</div>
                    </div>
                </div>
                
                <!-- Hamiltonian Terms Grid -->
                <div class="hamiltonian-grid">
            `;
            
            terms.forEach((term, index) => {
                // Parse the term: "coefficient * pauli_string"
                const match = term.match(/^([+-]?\d+\.?\d*)\s*\*\s*(.+)$/);
                if (match) {
                    const coefficient = parseFloat(match[1]);
                    const pauliString = match[2].trim();
                    
                    // Determine color intensity based on coefficient magnitude
                    const intensity = Math.abs(coefficient) / maxCoeff;
                    const alpha = 0.1 + intensity * 0.4; // 0.1 to 0.5 opacity
                    
                    hamiltonianHTML += `
                        <div class="hamiltonian-term" style="background: linear-gradient(135deg, rgba(255, 0, 0, ${alpha}), rgba(0, 0, 0, 0.8));">
                            <span class="term-coefficient">${coefficient >= 0 ? '+' : ''}${coefficient.toFixed(8)}</span>
                            <span class="term-operator"></span>
                            <span class="term-pauli">${pauliString}</span>
                        </div>
                    `;
                }
            });
            
            hamiltonianHTML += `
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 5px; text-align: center;">
                    <span style="color: #ccc; font-size: 0.7em;">
                         Hamiltonian decomposition showing Pauli operators with coefficients 
                    </span>
                </div>
            `;
            
            hamiltonianContainer.innerHTML = hamiltonianHTML;
        }
        
        // Create 3D molecular models
        let currentMolecularScene = null;
        
        function createMolecularModel(moleculeType = 'nh3') {
            const canvas = document.getElementById('nh3-canvas');
            if (!canvas) return;
            
            // Clean up previous scene
            if (currentMolecularScene) {
                currentMolecularScene.renderer.dispose();
            }
            
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x000000, 0);
            
            // Create materials with consistent color palette
            const nitrogenMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x0080ff,  // Blue for Nitrogen
                transparent: true,
                opacity: 0.9
            });
            const hydrogenMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xffffff,  // White for Hydrogen
                transparent: true,
                opacity: 0.8
            });
            const lithiumMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xdd88ff,  // Purple/Pink for Lithium
                transparent: true,
                opacity: 0.9
            });
            const bondMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff0000,  // Red for bonds
                transparent: true,
                opacity: 0.6
            });
            
            // Create geometries
            const hydrogenGeometry = new THREE.SphereGeometry(0.2, 12, 12);
            const nitrogenGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const lithiumGeometry = new THREE.SphereGeometry(0.4, 16, 16); // Larger for Lithium
            const bondGeometry = new THREE.CylinderGeometry(0.05, 0.05, 1, 8);
            
            if (moleculeType === 'nh3') {
                // Create NH3 (original code)
                const nitrogen = new THREE.Mesh(nitrogenGeometry, nitrogenMaterial);
                nitrogen.position.set(0, 0, 0);
                scene.add(nitrogen);
                
                const bondLength = 1.0;
                const bondAngle = 107 * Math.PI / 180;
                
                const hydrogenPositions = [
                    { x: 0, y: bondLength, z: 0 },
                    { 
                        x: bondLength * Math.sin(bondAngle) * Math.cos(0), 
                        y: -bondLength * Math.cos(bondAngle), 
                        z: bondLength * Math.sin(bondAngle) * Math.sin(0) 
                    },
                    { 
                        x: bondLength * Math.sin(bondAngle) * Math.cos(2 * Math.PI / 3), 
                        y: -bondLength * Math.cos(bondAngle), 
                        z: bondLength * Math.sin(bondAngle) * Math.sin(2 * Math.PI / 3) 
                    },
                    { 
                        x: bondLength * Math.sin(bondAngle) * Math.cos(4 * Math.PI / 3), 
                        y: -bondLength * Math.cos(bondAngle), 
                        z: bondLength * Math.sin(bondAngle) * Math.sin(4 * Math.PI / 3) 
                    }
                ];
                
                hydrogenPositions.forEach((pos, index) => {
                    const hydrogen = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                    hydrogen.position.set(pos.x, pos.y, pos.z);
                    scene.add(hydrogen);
                    
                    const bond = new THREE.Mesh(bondGeometry, bondMaterial);
                    bond.position.set(pos.x / 2, pos.y / 2, pos.z / 2);
                    
                    const direction = new THREE.Vector3(pos.x, pos.y, pos.z).normalize();
                    bond.lookAt(direction);
                    bond.rotateX(Math.PI / 2);
                    
                    scene.add(bond);
                });
                
                camera.position.set(2, 2, 3);
                
            } else if (moleculeType === 'h2') {
                // Create H2 molecule
                const bondLength = 0.74; // H-H bond length in Angstroms
                
                // First hydrogen atom
                const hydrogen1 = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogen1.position.set(-bondLength/2, 0, 0);
                scene.add(hydrogen1);
                
                // Second hydrogen atom
                const hydrogen2 = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogen2.position.set(bondLength/2, 0, 0);
                scene.add(hydrogen2);
                
                // Bond between hydrogens
                const bond = new THREE.Mesh(bondGeometry, bondMaterial);
                bond.position.set(0, 0, 0);
                bond.rotateZ(Math.PI / 2);
                bond.scale.set(1, bondLength, 1);
                scene.add(bond);
                
                camera.position.set(0, 1, 2);
                
            } else if (moleculeType === 'lih') {
                // Create LiH molecule
                const bondLength = 1.6; // Li-H bond length in Angstroms
                
                // Lithium atom (larger, purple)
                const lithium = new THREE.Mesh(lithiumGeometry, lithiumMaterial);
                lithium.position.set(-bondLength/2, 0, 0);
                scene.add(lithium);
                
                // Hydrogen atom (smaller, white)
                const hydrogen = new THREE.Mesh(hydrogenGeometry, hydrogenMaterial);
                hydrogen.position.set(bondLength/2, 0, 0);
                scene.add(hydrogen);
                
                // Bond between Li and H
                const bond = new THREE.Mesh(bondGeometry, bondMaterial);
                bond.position.set(0, 0, 0);
                bond.rotateZ(Math.PI / 2);
                bond.scale.set(1, bondLength, 1);
                scene.add(bond);
                
                camera.position.set(0, 1, 3);
            }
            
            camera.lookAt(0, 0, 0);
            
            // Add wireframe edges for better visibility
            scene.children.forEach(child => {
                if (child instanceof THREE.Mesh && child.geometry instanceof THREE.SphereGeometry) {
                    const edges = new THREE.EdgesGeometry(child.geometry);
                    const wireframe = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ffff }));
                    child.add(wireframe);
                }
            });
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                
                // Rotate the entire molecule
                scene.rotation.y += 0.01;
                scene.rotation.x += 0.005;
                
                renderer.render(scene, camera);
            }
            
            animate();
            
            // Handle resize
            function handleResize() {
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
            
            window.addEventListener('resize', handleResize);
            
            currentMolecularScene = { scene, camera, renderer };
            return currentMolecularScene;
        }
        
        // Update molecular info based on selected molecule
        function updateMolecularInfo(moleculeType) {
            const infoDiv = document.getElementById('molecular-info');
            const currentMoleculeName = document.getElementById('current-molecule-name');
            
            if (moleculeType === 'nh3') {
                infoDiv.innerHTML = `
                    <div><strong>Formula:</strong> NH (Ammonia)</div>
                    <div><strong>Geometry:</strong> Trigonal Pyramidal</div>
                    <div><strong>Bond Angle:</strong> ~107</div>
                    <div><strong>N-H Bond Length:</strong> ~1.01 </div>
                `;
                currentMoleculeName.textContent = 'NH Molecular System';
            } else if (moleculeType === 'h2') {
                infoDiv.innerHTML = `
                    <div><strong>Formula:</strong> H (Hydrogen)</div>
                    <div><strong>Geometry:</strong> Linear</div>
                    <div><strong>Bond Angle:</strong> 180</div>
                    <div><strong>H-H Bond Length:</strong> ~0.74 </div>
                `;
                currentMoleculeName.textContent = 'H Molecular System';
            } else if (moleculeType === 'lih') {
                infoDiv.innerHTML = `
                    <div><strong>Formula:</strong> LiH (Lithium Hydride)</div>
                    <div><strong>Geometry:</strong> Linear</div>
                    <div><strong>Bond Angle:</strong> 180</div>
                    <div><strong>Li-H Bond Length:</strong> ~1.6 </div>
                `;
                currentMoleculeName.textContent = 'LiH Molecular System';
            }
        }
        
        // Handle molecule selection
        function initializeMoleculeSelector() {
            const selector = document.getElementById('moleculeSelect');
            if (selector) {
                selector.addEventListener('change', (e) => {
                    const selectedMolecule = e.target.value;
                    updateMolecularInfo(selectedMolecule);
                    createMolecularModel(selectedMolecule);
                });
            }
        }
        
        // Legacy function name for compatibility
        function createNH3Model() {
            createMolecularModel('nh3');
            initializeMoleculeSelector();
        }
        
    </script>
</body>
</html>

